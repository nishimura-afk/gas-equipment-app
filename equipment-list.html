<div class="space-y-4">
  <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50 p-4 rounded-lg border">
    <div>
      <h2 class="text-lg font-bold text-slate-800"><i class="fas fa-list mr-2 text-blue-600"></i>全設備ステータス一覧</h2>
    </div>
    
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex items-center bg-white border rounded px-2 py-1">
        <i class="fas fa-calendar-alt text-gray-400 mr-2"></i>
        <select id="filter-year" class="text-sm outline-none bg-transparent" onchange="applyFilters()">
          <option value="ALL">全期間</option>
          <option value="THIS_YEAR">今年度実施 (~3月)</option>
          <option value="NEXT_YEAR">来年度実施 (4月~)</option>
        </select>
      </div>

      <div class="flex items-center bg-white border rounded px-2 py-1">
        <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
        <select id="filter-loc" class="text-sm outline-none bg-transparent" onchange="applyFilters()">
          <option value="ALL">全拠点表示</option>
        </select>
      </div>

      <!-- 新規: カテゴリーフィルター -->
      <div class="flex items-center bg-white border rounded px-2 py-1">
        <i class="fas fa-folder text-gray-400 mr-2"></i>
        <select id="filter-category" class="text-sm outline-none bg-transparent" onchange="applyFilters()">
          <option value="ALL">全カテゴリー</option>
          <option value="法定検査">法定検査</option>
          <option value="本体更新">本体更新</option>
          <option value="美観">美観</option>
          <option value="部材更新">部材更新</option>
          <option value="不定期">不定期</option>
        </select>
      </div>

      <!-- 新規: 設備名フィルター -->
      <div class="flex items-center bg-white border rounded px-2 py-1">
        <i class="fas fa-wrench text-gray-400 mr-2"></i>
        <select id="filter-equipment" class="text-sm outline-none bg-transparent" onchange="applyFilters()">
          <option value="ALL">全設備</option>
        </select>
      </div>
      
      <label class="flex items-center cursor-pointer bg-white border rounded px-3 py-1 hover:bg-amber-50 transition select-none">
        <input type="checkbox" id="filter-alert" class="mr-2 accent-amber-500" onchange="applyFilters()">
        <span class="text-sm font-bold text-amber-700"><i class="fas fa-exclamation-triangle mr-1"></i>アラートのみ</span>
      </label>

      <button onclick="listInit(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition shadow">
        <i class="fas fa-sync-alt mr-1"></i> 更新
      </button>
    </div>
  </div>

  <!-- ツールバー -->
  <div class="flex justify-between items-center p-3 bg-slate-50 border-b">
    <div class="flex gap-2">
      <button onclick="selectAllEquipments()" class="text-xs px-3 py-1 bg-white border rounded hover:bg-gray-50">
        <i class="fas fa-check-square mr-1"></i>すべて選択
      </button>
      <button onclick="deselectAllEquipments()" class="text-xs px-3 py-1 bg-white border rounded hover:bg-gray-50">
        <i class="fas fa-square mr-1"></i>選択解除
      </button>
    </div>
    <div class="flex gap-3 items-center">
      <span class="text-xs font-bold text-slate-600" id="equipment-selected-count">0件選択中</span>
      <button onclick="bulkCreateProjectsFromList()" 
              class="px-4 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 disabled:bg-gray-400"
              id="btn-bulk-project-list" disabled>
        <i class="fas fa-clipboard-list mr-1"></i>選択した設備を案件化
      </button>
      <button onclick="bulkCreateEmailsFromList()" 
              class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400"
              id="btn-bulk-email-list" disabled>
        <i class="fas fa-envelope mr-1"></i>選択した設備のメール作成
      </button>
    </div>
  </div>

  <div class="overflow-x-auto border rounded-lg shadow bg-white">
    <table class="w-full text-sm text-left whitespace-nowrap">
      <thead class="bg-slate-100 text-slate-700">
        <tr>
          <th class="p-3 border-b w-10">
            <input type="checkbox" class="equipment-checkbox-all accent-slate-600" onchange="toggleAllEquipments(this)">
          </th>
          <th class="p-3 border-b w-32">拠点名</th>
          <th class="p-3 border-b">設備名</th>
          <th class="p-3 border-b w-24">次回予定</th>
          <th class="p-3 border-b text-center w-32">消耗品/点検<br><span class="text-xs text-gray-400">(部品A)</span></th>
          <th class="p-3 border-b text-center w-32">定期整備<br><span class="text-xs text-gray-400">(部品B)</span></th>
          <th class="p-3 border-b text-center w-28">本体更新<br><span class="text-xs text-gray-400">(入替)</span></th>
          <th class="p-3 border-b text-center w-16">編集</th>
        </tr>
      </thead>
      <tbody id="list-table-body" class="divide-y bg-white"><tr><td colspan="8" class="p-8 text-center text-gray-500">読み込み中...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="eq-memo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96 border-t-4 border-blue-600">
    <h3 class="text-lg font-bold mb-4 text-gray-800"><i class="fas fa-edit mr-2 text-blue-600"></i>設備情報編集</h3>
    <p class="text-sm font-bold text-gray-700 mb-4" id="eq-memo-title"></p>
    <input type="hidden" id="eq-memo-shop"><input type="hidden" id="eq-memo-id">
    <div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-1">型式・仕様・契約容量</label><input type="text" id="eq-spec-text" class="w-full border rounded p-2"></div>
    <div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-1">次回作業メモ</label><textarea id="eq-memo-text" class="w-full border rounded p-2 h-24"></textarea></div>
    <div class="flex justify-end space-x-2"><button onclick="closeEqMemoModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button><button onclick="saveEqMemo()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">保存</button></div>
  </div>
</div>

<script>
let fullList = [];

function listInit(f=false) {
  if(!f && window.g_cache.list) { 
    fullList = window.g_cache.list;
    initFilters(fullList);
    applyFilters(); 
    return; 
  }
  showLoading(true); 
  google.script.run.withSuccessHandler(l => { 
    window.g_cache.list=l; 
    fullList = l;
    initFilters(l);
    applyFilters(); 
  }).getEquipmentList();
}

/**
 * 設備名から基本名を抽出（括弧とその中身を除去）
 */
function getBaseEquipmentName(equipmentName) {
  if (!equipmentName) return '';
  // 括弧とその中身を削除（全角・半角両対応）
  return equipmentName.replace(/[(\(（].*?[)\)）]/g, '').trim();
}

function initFilters(list) {
  // 拠点フィルターの初期化
  const locSel = document.getElementById('filter-loc');
  if (locSel.options.length <= 1) {
    const locs = new Set();
    list.forEach(r => locs.add(r['拠点名']));
    const sortedLocs = Array.from(locs).sort();
    sortedLocs.forEach(loc => {
      const op = document.createElement('option');
      op.value = loc; 
      op.innerText = loc; 
      locSel.appendChild(op);
    });
  }

  // 設備名フィルターの初期化（改善版）
  const eqSel = document.getElementById('filter-equipment');
  if (eqSel.options.length <= 1) {
    const equipments = new Set();
    list.forEach(r => {
      if (r['設備名']) {
        // 基本名を抽出してSetに追加
        const baseName = getBaseEquipmentName(r['設備名']);
        if (baseName) {
          equipments.add(baseName);
        }
      }
    });
    const sortedEqs = Array.from(equipments).sort();
    sortedEqs.forEach(eq => {
      const op = document.createElement('option');
      op.value = eq;
      op.innerText = eq;
      eqSel.appendChild(op);
    });
  }
}

function applyFilters() {
  const locFilter = document.getElementById('filter-loc').value;
  const categoryFilter = document.getElementById('filter-category').value;
  const equipmentFilter = document.getElementById('filter-equipment').value;
  const alertFilter = document.getElementById('filter-alert').checked;
  const yearFilter = document.getElementById('filter-year').value;
  
  const today = new Date();
  const thisYearEnd = new Date(today.getFullYear() + (today.getMonth() < 3 ? 0 : 1), 2, 31);
  const nextYearEnd = new Date(thisYearEnd.getFullYear() + 1, 2, 31);

  const filtered = fullList.filter(r => {
    // 拠点フィルター
    if (locFilter !== 'ALL' && r['拠点名'] !== locFilter) return false;
    
    // カテゴリーフィルター
    if (categoryFilter !== 'ALL' && r['カテゴリ'] !== categoryFilter) return false;
    
    // 設備名フィルター（改善版：基本名で比較）
    if (equipmentFilter !== 'ALL') {
      const baseName = getBaseEquipmentName(r['設備名']);
      if (baseName !== equipmentFilter) return false;
    }
    
    // アラートフィルター
    if (alertFilter) {
      const hasIssue = (r['部品Aステータス'] !== '正常') || 
                       (r['部品Bステータス'] !== '正常' && r['部品Bステータス']) || 
                       (r['本体ステータス'] !== '正常');
      if (!hasIssue) return false;
    }

    // 年度フィルター
    if (yearFilter !== 'ALL') {
      const nextDateStr = r['次回予定日'];
      if (!nextDateStr) return false;
      const nextDate = new Date(nextDateStr);
      
      if (yearFilter === 'THIS_YEAR') {
        if (nextDate > thisYearEnd) return false;
      } else if (yearFilter === 'NEXT_YEAR') {
        if (nextDate <= thisYearEnd || nextDate > nextYearEnd) return false;
      }
    }
    return true;
  });
  
  renderList(filtered);
}

function renderList(list) {
  showLoading(false); const tb = document.getElementById('list-table-body'); tb.innerHTML = '';
  if(!list||list.length===0) { tb.innerHTML='<tr><td colspan="8" class="p-8 text-center text-gray-500">条件に一致するデータがありません</td></tr>'; return; }
  list.sort((a,b)=>(a['拠点コード']>b['拠点コード'])?1:-1);
  list.forEach(r => {
    const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 transition group";
    const badge = (s) => {
      if(s==='期限超過'||s==='実施時期') return `<span class="inline-block px-2 py-1 rounded bg-red-100 text-red-700 font-bold text-xs border border-red-200">${s}</span>`;
      if(s==='注意') return `<span class="inline-block px-2 py-1 rounded bg-amber-100 text-amber-700 font-bold text-xs border border-amber-200">${s}</span>`;
      if(s==='正常') return `<span class="text-emerald-600 text-xs"><i class="fas fa-check mr-1"></i>正常</span>`;
      return `<span class="text-gray-300 text-xs">-</span>`;
    };
    const eqName = r['設備名']||r['設備ID'];
    const nextDate = r['次回予定日'] || '<span class="text-gray-300">-</span>';
    
    tr.innerHTML = `
      <td class="p-3 text-center border-r border-slate-100">
        <input type="checkbox" class="equipment-checkbox accent-slate-600"
               data-loc="${r['拠点コード']}"
               data-eq="${r['設備ID']}"
               data-name="${r['拠点名']}"
               data-eqname="${eqName}"
               onchange="updateEquipmentSelection()">
      </td>
      <td class="p-3 font-bold text-slate-700 border-r border-slate-100">${r['拠点名']}</td>
      <td class="p-3 border-r border-slate-100"><div class="font-bold text-slate-800">${eqName}</div>${r['spec']?`<div class="text-xs text-blue-600 mt-1"><i class="fas fa-tag mr-1"></i>${r['spec']}</div>`:''}</td>
      <td class="p-3 font-mono text-slate-800 border-r border-slate-100 font-bold bg-slate-50">${nextDate}</td>
      <td class="p-3 text-center border-r border-slate-100">${badge(r['部品Aステータス'])}</td>
      <td class="p-3 text-center border-r border-slate-100">${badge(r['部品Bステータス'])}</td>
      <td class="p-3 text-center border-r border-slate-100">${badge(r['本体ステータス'])}</td>
      <td class="p-3 text-center"><button onclick="openEqMemoModal('${r['拠点コード']}','${r['設備ID']}','${eqName}','${(r['nextWorkMemo']||'').replace(/\n/g,'\\n')}','${r['spec']||''}')" class="w-8 h-8 rounded-full border flex items-center justify-center mx-auto transition ${(r['nextWorkMemo']||r['spec'])?'text-blue-600 bg-blue-50 border-blue-200':'text-gray-400 bg-gray-100 hover:bg-gray-200'}"><i class="fas fa-edit"></i></button></td>
    `;
    tb.appendChild(tr);
  });
  updateEquipmentSelection();
}
function openEqMemoModal(s,i,n,m,p) { document.getElementById('eq-memo-shop').value=s; document.getElementById('eq-memo-id').value=i; document.getElementById('eq-memo-title').innerText=`${s} / ${n}`; document.getElementById('eq-memo-text').value=m; document.getElementById('eq-spec-text').value=p; document.getElementById('eq-memo-modal').classList.remove('hidden'); }
function closeEqMemoModal() { document.getElementById('eq-memo-modal').classList.add('hidden'); }
function saveEqMemo() { showLoading(true); closeEqMemoModal(); google.script.run.withSuccessHandler(()=>{window.g_cache.list=null;listInit(true);}).saveNextWorkMemo(document.getElementById('eq-memo-shop').value,document.getElementById('eq-memo-id').value,document.getElementById('eq-memo-text').value,document.getElementById('eq-spec-text').value); }

// ========================================
// 設備一覧 - チェックボックス操作
// ========================================

function updateEquipmentSelection() {
  const checked = document.querySelectorAll('.equipment-checkbox:checked');
  document.getElementById('equipment-selected-count').textContent = `${checked.length}件選択中`;
  document.getElementById('btn-bulk-project-list').disabled = (checked.length === 0);
  document.getElementById('btn-bulk-email-list').disabled = (checked.length === 0);
}

function selectAllEquipments() {
  document.querySelectorAll('.equipment-checkbox').forEach(cb => cb.checked = true);
  updateEquipmentSelection();
}

function deselectAllEquipments() {
  document.querySelectorAll('.equipment-checkbox').forEach(cb => cb.checked = false);
  updateEquipmentSelection();
}

function toggleAllEquipments(checkbox) {
  document.querySelectorAll('.equipment-checkbox').forEach(cb => cb.checked = checkbox.checked);
  updateEquipmentSelection();
}

function bulkCreateProjectsFromList() {
  const checked = Array.from(document.querySelectorAll('.equipment-checkbox:checked'));
  if (checked.length === 0) return;
  
  if (!confirm(`${checked.length}件の設備を案件化しますか?`)) return;
  
  showLoading(true);
  let completed = 0;
  
  checked.forEach((cb) => {
    const locCode = cb.dataset.loc;
    const eqId = cb.dataset.eq;
    const locName = cb.dataset.name;
    const eqName = cb.dataset.eqname;
    
    google.script.run
      .withSuccessHandler(() => {
        completed++;
        if (completed === checked.length) {
          showLoading(false);
          alert(`${completed}件の案件を作成しました`);
          deselectAllEquipments();
          navigate('progress');
        }
      })
      .withFailureHandler((error) => {
        showLoading(false);
        alert(`エラー: ${error}`);
      })
      .createIndividualProject(locCode, eqId, locName, eqName, '設備更新');
  });
}

function bulkCreateEmailsFromList() {
  const checked = Array.from(document.querySelectorAll('.equipment-checkbox:checked'));
  if (checked.length === 0) return;
  
  if (!confirm(`${checked.length}件のメール下書きを作成しますか?`)) return;
  
  showLoading(true);
  let completed = 0;
  
  checked.forEach((cb) => {
    const locCode = cb.dataset.loc;
    const eqId = cb.dataset.eq;
    const locName = cb.dataset.name;
    const eqName = cb.dataset.eqname;
    
    google.script.run
      .withSuccessHandler(() => {
        completed++;
        if (completed === checked.length) {
          showLoading(false);
          alert(`${completed}件のメール下書きを作成しました`);
          deselectAllEquipments();
        }
      })
      .withFailureHandler((error) => {
        showLoading(false);
        alert(`エラー: ${error}`);
      })
      .createIndividualGmailDraft(locCode, eqId, locName, eqName, '設備更新');
  });
}
</script>