<div class="space-y-8">
  
  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: å€‹åˆ¥æ¡ˆä»¶ã®è¦‹ç©ä¾é ¼ -->
  <div class="section-card">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-file-invoice mr-2 text-blue-600"></i>
        å€‹åˆ¥æ¡ˆä»¶ã®è¦‹ç©ä¾é ¼
      </h2>
      <p class="section-description">
        ã‚¢ãƒ©ãƒ¼ãƒˆå¤–ã®è¨­å‚™ã‚„ç·Šæ€¥å¯¾å¿œãªã©ã€å€‹åˆ¥ã«è¦‹ç©ã‚‚ã‚Šã‚’ä¾é ¼ã™ã‚‹å ´åˆ
      </p>
    </div>
    
    <div class="form-container">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">å¯¾è±¡æ‹ ç‚¹</label>
          <select id="email-loc-select" class="form-select" onchange="filterEquipmentsForEmail()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">å¯¾è±¡è¨­å‚™</label>
          <select id="email-eq-select" class="form-select">
            <option value="">æ‹ ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">ä½œæ¥­å†…å®¹</label>
          <input type="text" id="email-work-input" class="form-input" 
                 placeholder="ä¾‹: æœ¬ä½“å…¥æ›¿ã®è¦‹ç©ã‚‚ã‚Šã€æ•…éšœä¿®ç†">
        </div>
        
        <div class="form-group">
          <label class="form-label">å‹å¼ãƒ»å‚™è€ƒï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
          <input type="text" id="email-spec-input" class="form-input" 
                 placeholder="ä¾‹: ã‚¿ãƒ„ãƒè£½ å‹ç•ªä¸æ˜">
        </div>
      </div>
      
      <div class="form-actions">
        <button onclick="createIndividualDraft()" class="btn-primary">
          <i class="fas fa-envelope mr-2"></i>Gmailä¸‹æ›¸ã + æ¡ˆä»¶ä½œæˆ
        </button>
      </div>
    </div>
  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ãƒ™ãƒ³ãƒ€ãƒ¼åˆ¥ã¾ã¨ã‚ç™ºæ³¨ -->
  <div class="section-card">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-building mr-2 text-green-600"></i>
        ãƒ™ãƒ³ãƒ€ãƒ¼åˆ¥ã¾ã¨ã‚ç™ºæ³¨
      </h2>
      <p class="section-description">
        ç¾åœ¨ã‚¢ãƒ©ãƒ¼ãƒˆä¸­ã®è¨­å‚™ã‚’æ¥­è€…åˆ¥ã«é›†ç´„ã€‚å¿…è¦ãªã‚‚ã®ã ã‘é¸ã‚“ã§ã¾ã¨ã‚ã¦ç™ºæ³¨ã§ãã¾ã™
      </p>
    </div>
    
    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div class="vendor-toolbar">
      <button onclick="selectAllVendorItems()" class="btn-ghost">
        <i class="fas fa-check-square mr-1"></i>ã™ã¹ã¦é¸æŠ
      </button>
      <button onclick="deselectAllVendorItems()" class="btn-ghost">
        <i class="fas fa-square mr-1"></i>ã™ã¹ã¦è§£é™¤
      </button>
      <span class="selected-count" id="vendor-selected-count">0ä»¶é¸æŠä¸­</span>
    </div>
    
    <!-- ãƒ™ãƒ³ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ -->
    <div id="vendor-cards-container" class="vendor-cards">
      <div class="loading-placeholder">
        <i class="fas fa-spinner fa-spin mr-2"></i>èª­ã¿è¾¼ã¿ä¸­...
      </div>
    </div>

    <!-- ä¸€æ‹¬å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
    <div class="form-actions">
      <button onclick="createSelectedVendorDrafts()" 
              class="btn-primary" 
              id="btn-create-vendor-drafts"
              disabled>
        <i class="fas fa-envelope-open-text mr-2"></i>é¸æŠã—ãŸæ¡ˆä»¶ã®Gmailä¸‹æ›¸ãä½œæˆ
      </button>
    </div>
  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ¼ãƒ«ä½œæˆ -->
  <div class="section-card">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-edit mr-2 text-purple-600"></i>
        ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ¼ãƒ«ä½œæˆ
      </h2>
      <p class="section-description">
        ç‰¹æ®Šãªå†…å®¹ã‚„è¤‡æ•°è¨­å‚™ã®ã¾ã¨ã‚ä¾é ¼ãªã©ã€è‡ªç”±ã«ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆ
      </p>
    </div>
    
    <div class="form-container">
      <div class="form-grid">
        <div class="form-group full-width">
          <label class="form-label">å®›å…ˆï¼ˆæ¥­è€…åãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰</label>
          <input type="text" id="custom-to" class="form-input" 
                 placeholder="ä¾‹: ã‚¿ãƒ„ãƒï¼ˆtatsuno@example.comï¼‰">
        </div>
        
        <div class="form-group full-width">
          <label class="form-label">ä»¶å</label>
          <input type="text" id="custom-subject" class="form-input" 
                 value="ã€è¦‹ç©ä¾é ¼ã€‘è¦‹ç©ã‚‚ã‚Šä¾é ¼ã®ä»¶">
        </div>
        
        <div class="form-group full-width">
          <label class="form-label">æœ¬æ–‡</label>
          <textarea id="custom-body" class="form-textarea" rows="10" 
                    placeholder="ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚&#10;&#10;ä»¥ä¸‹ã«ã¤ã„ã¦è¦‹ç©ã‚‚ã‚Šã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button onclick="createCustomDraft()" class="btn-primary">
          <i class="fas fa-envelope mr-2"></i>Gmailä¸‹æ›¸ãä½œæˆ
        </button>
      </div>
    </div>
  </div>

</div>

<script>
// ========================================
// ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: å€‹åˆ¥æ¡ˆä»¶ã®è¦‹ç©ä¾é ¼
// ========================================

let allEquipmentsForEmail = [];

function emailInit(force = false) {
  console.log('ğŸ“§ emailInit called');
  
  // è¨­å‚™ãƒªã‚¹ãƒˆã®å–å¾—ï¼ˆå€‹åˆ¥æ¡ˆä»¶ç”¨ï¼‰
  if (!force && window.g_cache.list) {
    allEquipmentsForEmail = window.g_cache.list;
    populateEmailLocationSelect(allEquipmentsForEmail);
  } else {
    showLoading(true);
    google.script.run
      .withSuccessHandler((list) => {
        window.g_cache.list = list;
        allEquipmentsForEmail = list;
        populateEmailLocationSelect(list);
        showLoading(false);
      })
      .withFailureHandler((error) => {
        showLoading(false);
        alert('è¨­å‚™ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error);
      })
      .getEquipmentList();
  }
  
  // ãƒ™ãƒ³ãƒ€ãƒ¼åˆ¥é›†ç´„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
  loadVendorSummary();
}

function populateEmailLocationSelect(list) {
  const select = document.getElementById('email-loc-select');
  select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„...</option>';
  
  const locations = new Map();
  list.forEach(item => {
    if (item['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰'] && item['æ‹ ç‚¹å']) {
      locations.set(item['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰'], item['æ‹ ç‚¹å']);
    }
  });
  
  const sortedLocations = Array.from(locations).sort((a, b) => a[0] > b[0] ? 1 : -1);
  
  sortedLocations.forEach(([code, name]) => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = name;
    select.appendChild(option);
  });
}

function filterEquipmentsForEmail() {
  const locCode = document.getElementById('email-loc-select').value;
  const eqSelect = document.getElementById('email-eq-select');
  
  eqSelect.innerHTML = '<option value="">è¨­å‚™ã‚’é¸æŠ...</option>';
  
  if (!locCode) return;
  
  const equipments = allEquipmentsForEmail.filter(e => e['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰'] === locCode);
  
  equipments.forEach(eq => {
    const option = document.createElement('option');
    option.value = eq['è¨­å‚™ID'];
    option.textContent = eq['è¨­å‚™å'] || eq['è¨­å‚™ID'];
    option.dataset.spec = eq['spec'] || '';
    eqSelect.appendChild(option);
  });
}

function createIndividualDraft() {
  const locSelect = document.getElementById('email-loc-select');
  const eqSelect = document.getElementById('email-eq-select');
  const workInput = document.getElementById('email-work-input');
  const specInput = document.getElementById('email-spec-input');
  
  if (!locSelect.value || !eqSelect.value || !workInput.value) {
    alert('æ‹ ç‚¹ãƒ»è¨­å‚™ãƒ»ä½œæ¥­å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  const locName = locSelect.options[locSelect.selectedIndex].text;
  const eqName = eqSelect.options[eqSelect.selectedIndex].text;
  const locCode = locSelect.value;
  const eqId = eqSelect.value;
  const workType = workInput.value;
  const spec = specInput.value;
  
  if (!confirm(`Gmailä¸‹æ›¸ãã‚’ä½œæˆã—ã€æ¡ˆä»¶ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\n${locName} - ${eqName}\nä½œæ¥­: ${workType}`)) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler((result) => {
      showLoading(false);
      alert('âœ… Gmailä¸‹æ›¸ãã‚’ä½œæˆã—ã€æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nGmailã®ä¸‹æ›¸ããƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('email-work-input').value = '';
      document.getElementById('email-spec-input').value = '';
      
      // æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ–ã¸ç§»å‹•
      navigate('projects');
    })
    .withFailureHandler((error) => {
      showLoading(false);
      alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error);
    })
    .createIndividualDraftAndProject(locCode, locName, eqId, eqName, workType, spec);
}

// ========================================
// ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ãƒ™ãƒ³ãƒ€ãƒ¼åˆ¥ã¾ã¨ã‚ç™ºæ³¨
// ========================================

function loadVendorSummary() {
  console.log('ğŸ¢ Loading vendor summary...');
  
  const container = document.getElementById('vendor-cards-container');
  container.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin mr-2"></i>èª­ã¿è¾¼ã¿ä¸­...</div>';
  
  google.script.run
    .withSuccessHandler((vendorData) => {
      console.log('âœ… Vendor data received:', vendorData);
      renderVendorCards(vendorData);
    })
    .withFailureHandler((error) => {
      console.error('âŒ Vendor data error:', error);
      container.innerHTML = '<div class="error-placeholder">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    })
    .getVendorGroupedAlerts();
}

function renderVendorCards(vendorData) {
  const container = document.getElementById('vendor-cards-container');
  container.innerHTML = '';
  
  let hasItems = false;
  
  for (const vendorKey in vendorData) {
    const vendor = vendorData[vendorKey];
    if (vendor.items.length === 0) continue;
    
    hasItems = true;
    
    const card = createVendorCard(vendorKey, vendor);
    container.appendChild(card);
  }
  
  if (!hasItems) {
    container.innerHTML = '<div class="no-data-placeholder">ç¾åœ¨ã€ã‚¢ãƒ©ãƒ¼ãƒˆä¸­ã®è¨­å‚™ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  }
  
  updateVendorSelection();
}

function createVendorCard(vendorKey, vendor) {
  const card = document.createElement('div');
  card.className = 'vendor-card';
  card.dataset.vendor = vendorKey;
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼
  const header = document.createElement('div');
  header.className = 'vendor-card-header';
  header.innerHTML = `
    <div class="vendor-info">
      <input type="checkbox" 
             class="vendor-checkbox" 
             id="vendor-check-${vendorKey}"
             onchange="toggleVendorAll('${vendorKey}')">
      <label for="vendor-check-${vendorKey}" class="vendor-label">
        <strong>${getVendorIcon(vendorKey)} ${vendor.name}</strong>
        <span class="badge">${vendor.items.length}ä»¶</span>
      </label>
    </div>
    <button onclick="toggleVendorExpand('${vendorKey}')" class="btn-expand" id="btn-expand-${vendorKey}">
      <i class="fas fa-chevron-down"></i> è©³ç´°
    </button>
  `;
  
  // ãƒœãƒ‡ã‚£ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆï¼‰
  const body = document.createElement('div');
  body.className = 'vendor-card-body';
  body.id = `vendor-body-${vendorKey}`;
  body.style.display = 'none';
  
  const itemsList = document.createElement('div');
  itemsList.className = 'vendor-items-list';
  
  vendor.items.forEach((item, idx) => {
    const itemDiv = createVendorItem(vendorKey, item, idx);
    itemsList.appendChild(itemDiv);
  });
  
  body.appendChild(itemsList);
  
  // ãƒ™ãƒ³ãƒ€ãƒ¼å€‹åˆ¥ã®å®Ÿè¡Œãƒœã‚¿ãƒ³
  const actions = document.createElement('div');
  actions.className = 'vendor-actions';
  actions.innerHTML = `
    <button onclick="createSingleVendorDraft('${vendorKey}')" class="btn-secondary">
      <i class="fas fa-envelope mr-2"></i>${vendor.name}å®›ã¦ï¼ˆé¸æŠåˆ†ã®ã¿ï¼‰Gmailä¸‹æ›¸ã
    </button>
  `;
  body.appendChild(actions);
  
  card.appendChild(header);
  card.appendChild(body);
  
  return card;
}

function createVendorItem(vendorKey, item, idx) {
  const itemId = `${item['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰']}_${item['è¨­å‚™ID']}`;
  const isUrgent = item['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'æœŸé™è¶…é';
  const statusClass = isUrgent ? 'prepare' : 'alert';
  
  let statusLabel = '';
  if (item['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] !== 'æ­£å¸¸') {
    statusLabel = item['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
  } else if (item['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] !== 'æ­£å¸¸') {
    statusLabel = item['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
  } else if (item['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] && item['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] !== 'æ­£å¸¸') {
    statusLabel = item['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
  }
  
  const itemDiv = document.createElement('div');
  itemDiv.className = `vendor-item ${isUrgent ? 'urgent' : ''}`;
  itemDiv.innerHTML = `
    <input type="checkbox" 
           class="item-checkbox" 
           data-vendor="${vendorKey}"
           value="${itemId}"
           id="item-${vendorKey}-${idx}"
           onchange="updateVendorSelection()">
    <label for="item-${vendorKey}-${idx}" class="item-info">
      <div class="item-title">${item['æ‹ ç‚¹å']} - ${item['è¨­å‚™å']}</div>
      <div class="item-meta">
        ${statusLabel ? `<span class="status-badge ${statusClass}">${statusLabel}</span>` : ''}
        ${item['nextWorkMemo'] ? `<span class="item-detail">${item['nextWorkMemo']}</span>` : ''}
      </div>
    </label>
  `;
  
  return itemDiv;
}

function getVendorIcon(vendorKey) {
  const icons = {
    'TATSUNO': 'âš™ï¸',
    'ASAHI': 'ğŸ¨',
    'SHARP': 'ğŸ’³',
    'ALTIA': 'ğŸ’¨',
    'DAIICHI': 'ğŸ›¢ï¸',
    'OTHERS': 'ğŸ”§'
  };
  return icons[vendorKey] || 'ğŸ”§';
}

function toggleVendorAll(vendorKey) {
  const vendorCheck = document.getElementById(`vendor-check-${vendorKey}`);
  const itemChecks = document.querySelectorAll(`.item-checkbox[data-vendor="${vendorKey}"]`);
  
  itemChecks.forEach(checkbox => {
    checkbox.checked = vendorCheck.checked;
  });
  
  updateVendorSelection();
}

function toggleVendorExpand(vendorKey) {
  const body = document.getElementById(`vendor-body-${vendorKey}`);
  const button = document.getElementById(`btn-expand-${vendorKey}`);
  
  if (body.style.display === 'none') {
    body.style.display = 'block';
    button.innerHTML = '<i class="fas fa-chevron-up"></i> é–‰ã˜ã‚‹';
  } else {
    body.style.display = 'none';
    button.innerHTML = '<i class="fas fa-chevron-down"></i> è©³ç´°';
  }
}

function updateVendorSelection() {
  // å…¨ä½“ã®é¸æŠã‚«ã‚¦ãƒ³ãƒˆ
  const allChecked = document.querySelectorAll('.item-checkbox:checked');
  const count = allChecked.length;
  
  document.getElementById('vendor-selected-count').textContent = `${count}ä»¶é¸æŠä¸­`;
  
  // ä¸€æ‹¬å®Ÿè¡Œãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
  const btn = document.getElementById('btn-create-vendor-drafts');
  if (btn) {
    btn.disabled = (count === 0);
  }
  
  // å„ãƒ™ãƒ³ãƒ€ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹çŠ¶æ…‹ã‚’æ›´æ–°
  document.querySelectorAll('.vendor-checkbox').forEach(vendorCheck => {
    const vendorKey = vendorCheck.id.replace('vendor-check-', '');
    const itemChecks = document.querySelectorAll(`.item-checkbox[data-vendor="${vendorKey}"]`);
    const checkedItems = Array.from(itemChecks).filter(cb => cb.checked);
    
    if (checkedItems.length === 0) {
      vendorCheck.checked = false;
      vendorCheck.indeterminate = false;
    } else if (checkedItems.length === itemChecks.length) {
      vendorCheck.checked = true;
      vendorCheck.indeterminate = false;
    } else {
      vendorCheck.checked = false;
      vendorCheck.indeterminate = true;
    }
  });
}

function selectAllVendorItems() {
  document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = true);
  updateVendorSelection();
}

function deselectAllVendorItems() {
  document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = false);
  updateVendorSelection();
}

function createSingleVendorDraft(vendorKey) {
  const checkedItems = Array.from(
    document.querySelectorAll(`.item-checkbox[data-vendor="${vendorKey}"]:checked`)
  ).map(cb => cb.value);
  
  if (checkedItems.length === 0) {
    alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  const vendorLabel = document.querySelector(`#vendor-check-${vendorKey} + label strong`);
  const vendorName = vendorLabel ? vendorLabel.textContent.trim().replace(/^[^\s]+\s/, '') : 'ã“ã®æ¥­è€…';
  
  if (!confirm(`${vendorName}å®›ã¦ã®Gmailä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡: ${checkedItems.length}ä»¶`)) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler((result) => {
      showLoading(false);
      alert(`âœ… ${result.message}\n\nGmailã®ä¸‹æ›¸ããƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
      
      // ä½œæˆæ¸ˆã¿ã®é …ç›®ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
      checkedItems.forEach(itemId => {
        const checkbox = document.querySelector(`.item-checkbox[value="${itemId}"]`);
        if (checkbox) checkbox.checked = false;
      });
      updateVendorSelection();
      
      // æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ–ã¸ç§»å‹•
      navigate('projects');
    })
    .withFailureHandler((error) => {
      showLoading(false);
      alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error);
    })
    .createVendorDraftForSelected(vendorKey, checkedItems);
}

function createSelectedVendorDrafts() {
  const allChecked = document.querySelectorAll('.item-checkbox:checked');
  
  if (allChecked.length === 0) {
    alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  // ãƒ™ãƒ³ãƒ€ãƒ¼ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const vendorGroups = {};
  allChecked.forEach(checkbox => {
    const vendorKey = checkbox.dataset.vendor;
    if (!vendorGroups[vendorKey]) vendorGroups[vendorKey] = [];
    vendorGroups[vendorKey].push(checkbox.value);
  });
  
  const vendorCount = Object.keys(vendorGroups).length;
  const totalCount = allChecked.length;
  
  if (!confirm(`${vendorCount}ç¤¾ã«å¯¾ã—ã¦ã€åˆè¨ˆ${totalCount}ä»¶ã®Gmailä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler((result) => {
      showLoading(false);
      alert(`âœ… ${result.message}\n\nGmailã®ä¸‹æ›¸ããƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
      
      // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
      deselectAllVendorItems();
      
      // æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ–ã¸ç§»å‹•
      navigate('projects');
    })
    .withFailureHandler((error) => {
      showLoading(false);
      alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error);
    })
    .createMultipleVendorDrafts(vendorGroups);
}

// ========================================
// ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ¼ãƒ«ä½œæˆ
// ========================================

function createCustomDraft() {
  const to = document.getElementById('custom-to').value;
  const subject = document.getElementById('custom-subject').value;
  const body = document.getElementById('custom-body').value;
  
  if (!to || !subject || !body) {
    alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (!confirm('Gmailä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler((result) => {
      showLoading(false);
      alert('âœ… Gmailä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã—ãŸ\n\nGmailã®ä¸‹æ›¸ããƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('custom-body').value = '';
    })
    .withFailureHandler((error) => {
      showLoading(false);
      alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error);
    })
    .createCustomGmailDraft(to, subject, body);
}
</script>
