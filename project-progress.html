<div class="space-y-8">
  <div class="flex justify-between items-center border-b pb-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-tasks mr-2"></i>案件管理</h2>
      <p class="text-sm text-gray-600">見積依頼から日程調整、作業完了報告までを一元管理します。</p>
    </div>
    <button onclick="progressInit(true)" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold transition">
      <i class="fas fa-sync-alt mr-1"></i> 更新
    </button>
  </div>

  <div class="bg-white rounded-lg shadow border overflow-hidden">
    <div class="bg-blue-50 p-4 border-b">
      <div class="flex items-center text-xs text-gray-600 justify-between px-4 overflow-x-auto">
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold mr-2">1</span>見積依頼中</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold mr-2">2</span>見積受領</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold mr-2">3</span>発注済</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold mr-2">4</span>日程確定</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold mr-2"><i class="fas fa-check"></i></span>完了</div>
      </div>
    </div>
    
    <div id="progress-list-container" class="divide-y bg-white">
      <div class="p-8 text-center text-gray-500">読み込み中...</div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow border overflow-hidden">
    <div class="bg-gray-50 p-4 border-b">
      <h3 class="font-bold text-gray-800"><i class="fas fa-file-invoice-dollar mr-2"></i>見積り比較（外部DB参照）</h3>
      <p class="text-xs text-gray-600 mt-1">設備カテゴリごとの見積り一覧を表示します。</p>
    </div>
    <div class="p-4 flex flex-wrap items-center gap-3">
      <label class="text-sm font-bold text-gray-700">設備カテゴリ</label>
      <select id="estimate-category-select" class="border rounded p-2 text-sm">
        <option value="計量機">計量機</option>
        <option value="洗車機">洗車機</option>
        <option value="空調設備">空調設備</option>
        <option value="その他">その他</option>
      </select>
      <button onclick="showEstimateComparison(document.getElementById('estimate-category-select').value)" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow">
        <i class="fas fa-search mr-1"></i>見積り比較を表示
      </button>
    </div>
  </div>
</div>

<div id="schedule-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h3 class="text-lg font-bold mb-4 text-gray-800"><i class="fas fa-calendar-plus mr-2"></i>日程登録</h3>
    <p class="text-sm text-gray-600 mb-4 font-bold" id="sched-modal-desc"></p>
    <input type="hidden" id="sched-id">
    <input type="hidden" id="sched-loc-hidden">
    <input type="hidden" id="sched-eq-hidden">
    <input type="hidden" id="sched-work-hidden">
    <div class="mb-4">
      <label class="block text-sm font-bold mb-1 text-gray-700">施工予定日</label>
      <input type="date" id="sched-date" class="w-full border rounded p-2">
    </div>
    <div class="mb-4">
      <label class="block text-sm font-bold mb-1 text-slate-600">備考</label>
      <textarea class="w-full border rounded p-2 text-sm" placeholder="業者名や見積状況など" id="sched-notes"></textarea>
    </div>
    <div class="flex justify-end space-x-2">
      <button onclick="closeScheduleModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
      <button onclick="submitSchedule()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold shadow">確定</button>
    </div>
  </div>
</div>

<div id="estimate-comparison-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
    <div class="p-4 border-b flex justify-between items-center">
      <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-file-invoice-dollar mr-2"></i>見積り比較</h3>
      <button onclick="closeComparisonModal()" class="text-gray-500 hover:text-gray-700 p-1"><i class="fas fa-times text-xl"></i></button>
    </div>
    <div id="estimate-comparison-stats" class="p-4 bg-blue-50 border-b text-sm"></div>
    <div id="estimate-comparison-list" class="p-4 overflow-y-auto flex-1"></div>
    <div class="p-4 border-t">
      <button onclick="closeComparisonModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">閉じる</button>
    </div>
  </div>
</div>

<script>
function progressInit(f=false) {
  if(!f && window.g_cache.progress) { 
    renderStatusBars(window.g_cache.progress); 
    return; 
  }
  showLoading(true); 
  google.script.run.withSuccessHandler(r => { 
    window.g_cache.progress=r; 
    renderStatusBars(r); 
    showLoading(false);
  }).getAllActiveProjects();
}

function renderStatusBars(projects) {
  const c = document.getElementById('progress-list-container'); c.innerHTML = '';
  if(!projects || projects.length === 0) { 
    c.innerHTML = '<div class="p-8 text-center text-gray-500">現在進行中の案件はありません</div>'; 
    return; 
  }
  
  const steps = { '見積依頼中': 1, '見積受領': 2, '発注済': 3, '日程確定': 4 };
  projects.sort((a,b) => (steps[b.status]||0) - (steps[a.status]||0));
  
  projects.forEach(p => {
    const s = steps[p.status]||0;
    const w = (s/4)*100;
    const color = s===4 ? 'bg-green-500' : 'bg-blue-500';
    
    let btn = '';
    if(p.status==='見積依頼中') btn=`<button onclick="updateStatus('${p.id}','見積受領')" class="bg-indigo-500 text-white px-2 py-1 rounded text-xs hover:bg-indigo-600">受領へ</button>`;
    else if(p.status==='見積受領') btn=`<button onclick="updateStatus('${p.id}','発注済')" class="bg-orange-500 text-white px-2 py-1 rounded text-xs hover:bg-orange-600">発注へ</button>`;
    else if(p.status==='発注済') btn=`<button onclick="openScheduleModal('${p.id}','${p.locName}','${p.equipmentId}','${p.workType}')" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">日程登録</button>`;
    else if(p.status==='日程確定') btn=`<button onclick="openCompleteModal('${p.id}','${p.rowNumber}','${p.date}','${p.workType}','${p.locName}','${p.equipmentName||p.equipmentId}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">完了報告</button>`;
    
    const div = document.createElement('div'); 
    div.className="p-3 hover:bg-gray-50 grid grid-cols-12 gap-4 items-center";
    div.innerHTML=`
      <div class="col-span-4 pl-2">
        <div class="font-bold text-gray-800 text-sm">${p.locName}</div>
        <div class="text-xs text-gray-500">${p.workType} (${p.equipmentName||p.equipmentId})</div>
        ${p.date ? `<div class="mt-1"><span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded">${p.date}</span></div>` : ''}
      </div>
      <div class="col-span-5 relative h-3 bg-gray-200 rounded-full overflow-hidden">
        <div class="absolute top-0 left-0 h-full ${color}" style="width: ${w}%"></div>
      </div>
      <div class="col-span-3 text-right flex justify-end items-center gap-2">
        ${btn}
        <button onclick="deleteProject('${p.id}')" class="text-gray-400 hover:text-red-500 p-1 transition" title="案件を取り消す"><i class="fas fa-trash-alt"></i></button>
      </div>`;
    c.appendChild(div);
  });
}

function updateStatus(id,st) { 
  if(confirm('ステータスを更新しますか？')){ 
    showLoading(true); 
    google.script.run.withSuccessHandler(()=>{clearCache('progress');progressInit(true);}).updateProjectStatus(id,st); 
  }
}

function deleteProject(id) { 
  if(confirm('この案件を取り消しますか？\n（未完了のまま終了し、履歴に残します）')){ 
    showLoading(true); 
    google.script.run.withSuccessHandler(()=>{clearCache('progress');progressInit(true);}).cancelProject(id); 
  }
}

function openScheduleModal(id,l,e,w) { 
  document.getElementById('sched-id').value=id; 
  document.getElementById('sched-date').value=''; 
  document.getElementById('sched-notes').value=''; 
  document.getElementById('sched-modal-desc').innerText=`${l} / ${e} - ${w}`; 
  document.getElementById('schedule-modal').classList.remove('hidden'); 
}

function directSchedule(l,e,w) { 
  document.getElementById('sched-id').value='DIRECT'; 
  // hidden input に値をセット
  document.getElementById('sched-loc-hidden').value=l; 
  document.getElementById('sched-eq-hidden').value=e; 
  document.getElementById('sched-work-hidden').value=w; 
  
  document.getElementById('sched-date').value=''; 
  document.getElementById('sched-notes').value=''; 
  document.getElementById('sched-modal-desc').innerText=`新規: ${l} - ${w}`; 
  document.getElementById('schedule-modal').classList.remove('hidden'); 
}

function closeScheduleModal() { document.getElementById('schedule-modal').classList.add('hidden'); }

function submitSchedule() {
  const id=document.getElementById('sched-id').value, d=document.getElementById('sched-date').value, n=document.getElementById('sched-notes').value;
  if(!d) return alert('日付を入力してください'); 
  showLoading(true); 
  closeScheduleModal();
  const cb=()=>{clearCache('progress');progressInit(true);};
  if(id==='DIRECT') google.script.run.withSuccessHandler(cb).createScheduleAndRecord(document.getElementById('sched-loc-hidden').value,document.getElementById('sched-eq-hidden').value,document.getElementById('sched-work-hidden').value,d,n);
  else google.script.run.withSuccessHandler(cb).createScheduleAndRecord('','','',d,n,id);
}

function showEstimateComparison(category) {
  if (!category) return;
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(data) {
      showLoading(false);
      showComparisonModal(data);
    })
    .withFailureHandler(function(err) {
      showLoading(false);
      alert('見積りデータの取得に失敗しました: ' + err);
    })
    .getEstimateComparison(category);
}

function showComparisonModal(data) {
  var modal = document.getElementById('estimate-comparison-modal');
  var statsEl = document.getElementById('estimate-comparison-stats');
  var listEl = document.getElementById('estimate-comparison-list');
  if (!modal || !statsEl || !listEl) return;

  var stats = data.stats || {};
  var estimates = data.estimates || [];
  var category = data.category || '';

  statsEl.innerHTML = '<span class="font-bold text-blue-800">' + category + '</span> — ' +
    '件数: ' + stats.count + '件' +
    (stats.min > 0 ? ' | 最安: ¥' + Number(stats.min).toLocaleString() : '') +
    (stats.max > 0 ? ' | 最高: ¥' + Number(stats.max).toLocaleString() : '') +
    (stats.average > 0 ? ' | 平均: ¥' + Math.round(stats.average).toLocaleString() : '');

  if (estimates.length === 0) {
    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">該当する見積りはありません。</p>';
  } else {
    var html = '<table class="w-full text-sm border-collapse"><thead><tr class="bg-gray-100 border-b">' +
      '<th class="text-left p-2">拠点名</th><th class="text-left p-2">業者名</th><th class="text-right p-2">金額</th><th class="text-left p-2">見積日</th><th class="text-left p-2">PDF</th></tr></thead><tbody>';
    estimates.forEach(function(e) {
      var dateStr = e.estimateDate ? (e.estimateDate instanceof Date ? e.estimateDate.toISOString().slice(0,10) : String(e.estimateDate).slice(0,10)) : '-';
      var amountStr = e.amount ? '¥' + Number(e.amount).toLocaleString() : '-';
      var pdfLink = e.pdfUrl ? '<a href="' + e.pdfUrl + '" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-external-link-alt"></i> 開く</a>' : '-';
      html += '<tr class="border-b hover:bg-gray-50">' +
        '<td class="p-2">' + (e.location || '-') + '</td>' +
        '<td class="p-2">' + (e.vendor || '-') + '</td>' +
        '<td class="p-2 text-right">' + amountStr + '</td>' +
        '<td class="p-2">' + dateStr + '</td>' +
        '<td class="p-2">' + pdfLink + '</td></tr>';
    });
    html += '</tbody></table>';
    listEl.innerHTML = html;
  }

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeComparisonModal() {
  var modal = document.getElementById('estimate-comparison-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}
</script>