<div class="space-y-6">
  <div class="flex justify-between items-center border-b pb-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-file-import mr-2"></i>è¦‹ç©ãƒ»è³‡æ–™ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
      <p class="text-sm text-gray-600">PDFè¦‹ç©æ›¸ã‚’å–ã‚Šè¾¼ã¿ã€æ¡ˆä»¶ã¨ç´ä»˜ã‘ã¦æ•´ç†ã—ã¾ã™ã€‚</p>
    </div>
  </div>

  <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
    <button onclick="switchTab('inbox')" id="tab-inbox" class="flex-1 py-2 px-4 rounded-md text-sm font-bold bg-white shadow text-blue-600 transition">
      <i class="fas fa-inbox mr-2"></i>å—ä¿¡BOX (è‡ªå‹•æ¤œçŸ¥)
    </button>
    <button onclick="switchTab('drive')" id="tab-drive" class="flex-1 py-2 px-4 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200 transition">
      <i class="fab fa-google-drive mr-2"></i>Driveãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®š
    </button>
    <button onclick="switchTab('local')" id="tab-local" class="flex-1 py-2 px-4 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200 transition">
      <i class="fas fa-laptop mr-2"></i>PCã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>

  <!-- å—ä¿¡BOXã‚¿ãƒ– -->
  <div id="area-inbox" class="tab-content">
    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4 flex justify-between items-center">
      <div>
        <h3 class="font-bold text-blue-800">SSè¦‹ç©_å—ä¿¡BOX</h3>
        <p class="text-xs text-blue-600">Gmailç­‰ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
      </div>
      <button onclick="scanInbox()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow">
        <i class="fas fa-sync-alt mr-1"></i> å†ã‚¹ã‚­ãƒ£ãƒ³
      </button>
    </div>
    <div id="inbox-list" class="space-y-2">
      <div class="p-8 text-center text-gray-400">ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</div>
    </div>
  </div>

  <!-- Driveãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šã‚¿ãƒ– -->
  <div id="area-drive" class="tab-content hidden">
    <div class="bg-white border rounded p-6 text-center">
      <p class="mb-4 text-sm text-gray-600">éå»ã®è¦‹ç©æ›¸ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹Driveãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <div class="flex max-w-lg mx-auto gap-2">
        <input type="text" id="drive-folder-id" class="flex-1 border rounded p-2 text-sm" placeholder="ãƒ•ã‚©ãƒ«ãƒ€ID (URLã®æœ«å°¾éƒ¨åˆ†)">
        <button onclick="scanDrive()" class="bg-gray-700 text-white px-6 py-2 rounded font-bold hover:bg-gray-800">
          <i class="fas fa-search mr-1"></i> æ¤œç´¢
        </button>
      </div>
    </div>
    <div id="drive-list" class="space-y-2 mt-4"></div>
  </div>

  <!-- PCã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ– -->
  <div id="area-local" class="tab-content hidden">
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center bg-gray-50 hover:bg-gray-100 transition relative" id="drop-zone">
      <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple accept="application/pdf" onchange="handleFileSelect(this)">
      <div class="pointer-events-none">
        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
        <p class="font-bold text-gray-600">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
        <p class="text-xs text-gray-400 mt-1">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ (PDFã®ã¿ã€è¤‡æ•°é¸æŠå¯)</p>
      </div>
    </div>
    <div id="upload-preview" class="mt-4 space-y-3 hidden">
      <!-- å„ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ã«ç”Ÿæˆ -->
    </div>
  </div>

  <!-- ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ï¼ˆå—ä¿¡BOXãƒ»Driveç”¨ï¼‰ -->
  <div id="bulk-action-area" class="hidden fixed bottom-6 right-6 z-50">
    <button onclick="execBulkImport()" class="bg-green-600 text-white px-8 py-4 rounded-full shadow-lg font-bold hover:bg-green-700 flex items-center transform transition hover:scale-105">
      <i class="fas fa-check-circle text-xl mr-2"></i>
      <span id="bulk-count">0</span>ä»¶ã‚’ç™»éŒ²ã—ã¦æ•´ç†
    </button>
  </div>

  <!-- PCã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ -->
  <div id="upload-bulk-action-area" class="hidden fixed bottom-6 right-6 z-50">
    <button onclick="execBulkUpload()" class="bg-green-600 text-white px-8 py-4 rounded-full shadow-lg font-bold hover:bg-green-700 flex items-center transform transition hover:scale-105">
      <i class="fas fa-check-circle text-xl mr-2"></i>
      <span id="upload-bulk-count">0</span>ä»¶ã‚’ç™»éŒ²ã—ã¦æ•´ç†
    </button>
  </div>
</div>

<script>
console.log('âœ… import.html script loaded');

// ========================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾©ï¼ˆæœ€å„ªå…ˆï¼‰
// ========================================
window.allProjects = [];
window.allEquipmentsForEmail = [];
window.selectedFiles = [];

let currentFiles = []; 
let uploadedFiles = []; // PCã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«é…åˆ—

// ========================================
// åˆæœŸåŒ–é–¢æ•°
// ========================================
function importInit() {
  console.log('ğŸš€ importInit called');
  
  // æ—¢å­˜æ¡ˆä»¶ã‚’å–å¾—
  google.script.run
    .withSuccessHandler(function(projects) {
      window.allProjects = projects || [];
      console.log('âœ… getAllActiveProjects success:', window.allProjects.length);
      console.log('ğŸ“Š Sample project:', window.allProjects[0]);
      
      // è¨­å‚™ãƒã‚¹ã‚¿ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(equipments) {
          window.allEquipmentsForEmail = equipments || [];
          console.log('âœ… getEquipmentList success:', window.allEquipmentsForEmail.length);
          console.log('ğŸ“Š Sample equipment:', window.allEquipmentsForEmail[0]);
          
          // ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ãŒæƒã£ãŸã‚‰çµ±åˆ
          mergeProjectsAndEquipments();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ getEquipmentList failed:', error);
          alert('è¨­å‚™ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
        })
        .getEquipmentList();
    })
    .withFailureHandler(function(error) {
      console.error('âŒ getAllActiveProjects failed:', error);
      alert('æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
    })
    .getAllActiveProjects();
}

// ========================================
// ãƒ‡ãƒ¼ã‚¿çµ±åˆé–¢æ•°
// ========================================
function mergeProjectsAndEquipments() {
  console.log('ğŸ”„ Merging data...');
  
  const existingProjects = window.allProjects || [];
  const equipments = window.allEquipmentsForEmail || [];
  
  // æ–°è¦æ¡ˆä»¶ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
  const newProjectOptions = equipments.map(function(eq) {
    return {
      val: `NEW:${eq['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰']}:${eq['è¨­å‚™ID']}`,
      label: `ã€æ–°è¦ã€‘${eq['æ‹ ç‚¹å']} - ${eq['è¨­å‚™å']}`,
      isNew: true,
      locCode: eq['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰'],
      locName: eq['æ‹ ç‚¹å'],
      eqId: eq['è¨­å‚™ID'],
      eqName: eq['è¨­å‚™å']
    };
  });
  
  // æ—¢å­˜æ¡ˆä»¶ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  const existingOptions = existingProjects.map(function(proj) {
    // æ¡ˆä»¶IDã®çŸ­ç¸®ç‰ˆã‚’ä½œæˆï¼ˆè¡¨ç¤ºç”¨ï¼‰
    const shortId = proj.id ? proj.id.substring(0, 8) : '';
    
    return {
      val: `EXISTING:${proj.id}`,
      label: `æ¡ˆä»¶#${shortId}: ${proj.locName} - ${proj.equipmentName || proj.equipmentId} - ${proj.workType}`,
      isNew: false,
      id: proj.id,
      locCode: proj.locCode,
      locName: proj.locName,
      equipmentName: proj.equipmentName || proj.equipmentId,
      workType: proj.workType
    };
  });
  
  // çµ±åˆï¼ˆæ–°è¦ã‚’å…ˆã«ï¼‰
  window.allProjects = [...newProjectOptions, ...existingOptions];
  
  console.log('âœ… Data merged:', window.allProjects.length);
  console.log('ğŸ“Š æ–°è¦æ¡ˆä»¶:', newProjectOptions.length);
  console.log('ğŸ“Š æ—¢å­˜æ¡ˆä»¶:', existingOptions.length);
  console.log('ğŸ“Š Sample merged data:', window.allProjects.slice(0, 3));
  
  // å—ä¿¡BOXã‚’ã‚¹ã‚­ãƒ£ãƒ³
  scanInbox();
}

/**
 * ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
 */
function switchTab(tab) {
  console.log('ğŸ”„ Switching to tab:', tab);
  
  document.querySelectorAll('.tab-content').forEach(function(el) {
    el.classList.add('hidden');
  });
  document.getElementById('area-' + tab).classList.remove('hidden');
  
  document.querySelectorAll('button[id^="tab-"]').forEach(function(btn) {
    btn.classList.remove('bg-white', 'shadow', 'text-blue-600');
    btn.classList.add('text-gray-500', 'hover:bg-gray-200');
  });
  
  const activeBtn = document.getElementById('tab-' + tab);
  activeBtn.classList.remove('text-gray-500', 'hover:bg-gray-200');
  activeBtn.classList.add('bg-white', 'shadow', 'text-blue-600');
  
  // PCã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ–ã®å ´åˆã¯ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
  if (tab === 'local') {
    document.getElementById('bulk-action-area').classList.add('hidden');
  } else {
    document.getElementById('upload-bulk-action-area').classList.add('hidden');
  }
}

/**
 * å—ä¿¡BOXã‚’ã‚¹ã‚­ãƒ£ãƒ³
 */
function scanInbox() {
  console.log('ğŸ“¥ Scanning inbox...');
  showLoading(true);
  document.getElementById('inbox-list').innerHTML = '<div class="p-4 text-center">ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</div>';
  
  google.script.run
    .withSuccessHandler(function(res) {
      console.log('âœ… scanInboxFiles success:', res);
      renderFiles(res);
    })
    .withFailureHandler(function(error) {
      console.error('âŒ scanInboxFiles failed:', error);
      showLoading(false);
      alert('ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
    })
    .scanInboxFiles();
}

/**
 * Driveãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒ£ãƒ³
 */
function scanDrive() {
  const id = document.getElementById('drive-folder-id').value;
  if (!id) {
    alert('ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  console.log('ğŸ“ Scanning drive folder:', id);
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(res) {
      console.log('âœ… scanDriveFolder success:', res);
      if (!res.success) {
        showLoading(false);
        alert(res.error);
        return;
      }
      renderFiles(res);
    })
    .withFailureHandler(function(error) {
      console.error('âŒ scanDriveFolder failed:', error);
      showLoading(false);
      alert('ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
    })
    .scanDriveFolder(id);
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æç”»ï¼ˆå—ä¿¡BOXãƒ»Driveç”¨ï¼‰
 */
function renderFiles(res) {
  console.log('ğŸ¨ Rendering files:', res);
  showLoading(false);
  
  const container = document.querySelector('.tab-content:not(.hidden) div[id$="-list"]');
  if (!container) {
    console.error('âŒ Container not found');
    return;
  }
  
  container.innerHTML = '';
  
  if (res.files.length === 0) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">PDFãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
    document.getElementById('bulk-action-area').classList.add('hidden');
    return;
  }

  currentFiles = res.files;

  // æ¡ˆä»¶åŒ–æ¸ˆã¿/æœªæ¡ˆä»¶åŒ–ã«åˆ†é¡
  const existingProjects = [];
  const newEquipments = {};
  
  res.files.forEach(function(file, idx) {
    if (file.suggestion) {
      if (file.suggestion.type === 'EXISTING') {
        existingProjects.push({
          file: file,
          idx: idx,
          projectId: file.suggestion.id,
          label: file.suggestion.label,
          detailLabel: file.suggestion.detailLabel || file.suggestion.label
        });
      } else if (file.suggestion.type === 'NEW') {
        const equipmentName = getBaseEquipmentName(file.suggestion.eqName);
        
        if (!newEquipments[equipmentName]) {
          newEquipments[equipmentName] = [];
        }
        
        newEquipments[equipmentName].push({
          file: file,
          idx: idx,
          locCode: file.suggestion.locCode,
          locName: file.suggestion.locName,
          eqId: file.suggestion.eqId,
          eqName: file.suggestion.eqName
        });
      }
    }
  });

  // æ¡ˆä»¶åŒ–æ¸ˆã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æç”»
  if (existingProjects.length > 0) {
    const section = createSectionHeader('æ¡ˆä»¶åŒ–æ¸ˆã¿', existingProjects.length, 'blue');
    container.appendChild(section);
    
    existingProjects.forEach(function(item) {
      const div = createExistingProjectItem(item);
      container.appendChild(div);
    });
  }

  // æ–°è¦æ¡ˆä»¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æç”»
  if (Object.keys(newEquipments).length > 0) {
    const totalNew = Object.values(newEquipments).reduce(function(sum, items) {
      return sum + items.length;
    }, 0);
    const section = createSectionHeader('æ–°è¦æ¡ˆä»¶', totalNew, 'green');
    container.appendChild(section);
    
    Object.keys(newEquipments).sort().forEach(function(equipmentName) {
      const items = newEquipments[equipmentName];
      const div = createNewEquipmentGroup(equipmentName, items);
      container.appendChild(div);
    });
  }

  updateBulkCount();
}

/**
 * è¨­å‚™åã‹ã‚‰åŸºæœ¬åã‚’æŠ½å‡ºï¼ˆæ‹¬å¼§ã‚’é™¤å»ï¼‰
 */
function getBaseEquipmentName(equipmentName) {
  if (!equipmentName) return 'ä¸æ˜ãªè¨­å‚™';
  return equipmentName.replace(/[(\(ï¼ˆ].*?[)\)ï¼‰]/g, '').trim();
}

/**
 * ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
 */
function createSectionHeader(title, count, color) {
  const section = document.createElement('div');
  let className, badgeClassName;
  if (color === 'blue') {
    className = 'bg-blue-50 border-blue-200 border-b-2 p-3 font-bold text-blue-800 flex items-center gap-2';
    badgeClassName = 'text-xs bg-blue-100 px-2 py-1 rounded';
  } else if (color === 'green') {
    className = 'bg-green-50 border-green-200 border-b-2 p-3 font-bold text-green-800 flex items-center gap-2';
    badgeClassName = 'text-xs bg-green-100 px-2 py-1 rounded';
  } else {
    className = 'bg-gray-50 border-gray-200 border-b-2 p-3 font-bold text-gray-800 flex items-center gap-2';
    badgeClassName = 'text-xs bg-gray-100 px-2 py-1 rounded';
  }
  
  section.className = className;
  section.innerHTML = `
    <i class="fas fa-folder-open"></i>
    <span>${title}</span>
    <span class="${badgeClassName}">${count}ä»¶</span>
  `;
  return section;
}

/**
 * æ—¢å­˜æ¡ˆä»¶ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
 */
function createExistingProjectItem(item) {
  const div = document.createElement('div');
  div.className = "bg-white p-3 border-b flex items-center gap-3 hover:bg-blue-50";
  
  const displayLabel = item.detailLabel || item.label;
  
  div.innerHTML = `
    <input type="checkbox" 
           class="import-check w-5 h-5 accent-blue-600" 
           data-idx="${item.idx}" 
           checked
           onchange="updateBulkCount()">
    <div class="flex-1 min-w-0">
      <div class="font-bold text-sm text-blue-600">
        <i class="fas fa-link mr-1"></i>${displayLabel}
      </div>
      <div class="text-xs text-gray-500 mt-1">
        <a href="${item.file.url}" target="_blank" class="hover:underline">
          <i class="fas fa-file-pdf mr-1"></i>${item.file.name}
        </a>
      </div>
    </div>
    <select class="border rounded p-1 text-sm import-select bg-white" data-idx="${item.idx}">
      <option value="EXISTING:${item.projectId}" selected>ã“ã®æ¡ˆä»¶ã«ç´ä»˜ã‘</option>
    </select>
  `;
  
  return div;
}

/**
 * æ–°è¦è¨­å‚™ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
 */
function createNewEquipmentGroup(equipmentName, items) {
  const groupDiv = document.createElement('div');
  groupDiv.className = "border-b";
  
  const header = document.createElement('div');
  header.className = "bg-green-50 p-3 flex items-center gap-3 cursor-pointer hover:bg-green-100";
  header.onclick = function() { toggleGroup(equipmentName); };
  
  const storeList = items.map(function(i) { return i.locName; }).join('ã€');
  const storeCount = items.length;
  
  header.innerHTML = `
    <input type="checkbox" 
           class="group-checkbox w-5 h-5 accent-green-600" 
           data-equipment="${equipmentName}"
           onchange="toggleGroupCheckboxes('${equipmentName}')"
           onclick="event.stopPropagation()"
           checked>
    <div class="flex-1">
      <div class="font-bold text-sm text-green-800">
        <i class="fas fa-wrench mr-1"></i>æ–°è¦: ${equipmentName}æ›´æ–°
      </div>
      <div class="text-xs text-green-600 mt-1">
        è©²å½“: ${storeCount}åº—èˆ—ï¼ˆ${storeList}ï¼‰
      </div>
    </div>
    <i class="fas fa-chevron-up text-gray-400" id="chevron-${equipmentName}"></i>
  `;
  
  const body = document.createElement('div');
  body.id = `group-body-${equipmentName}`;
  body.className = "bg-gray-50";
  
  items.forEach(function(item) {
    const itemDiv = document.createElement('div');
    itemDiv.className = "p-3 pl-12 border-t flex items-center gap-3 hover:bg-white";
    
    const selectOptions = generateExistingProjectOptions(item.locCode, item.eqId, item.locName);
    
    itemDiv.innerHTML = `
      <input type="checkbox" 
             class="import-check equipment-check w-4 h-4 accent-green-600" 
             data-idx="${item.idx}"
             data-equipment="${equipmentName}"
             checked
             onchange="updateBulkCount(); updateGroupCheckbox('${equipmentName}')">
      <div class="flex-1 text-sm">
        <span class="font-bold">${item.locName}</span>
        <a href="${item.file.url}" target="_blank" class="text-xs text-gray-500 ml-2 hover:underline">
          <i class="fas fa-file-pdf mr-1"></i>${item.file.name}
        </a>
      </div>
      <select class="border rounded p-1 text-xs import-select bg-white" data-idx="${item.idx}">
        <option value="NEW:${item.locCode}:${item.eqId}" selected>æ–°è¦æ¡ˆä»¶ä½œæˆ</option>
        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
        ${selectOptions}
      </select>
    `;
    
    body.appendChild(itemDiv);
  });
  
  groupDiv.appendChild(header);
  groupDiv.appendChild(body);
  
  return groupDiv;
}

/**
 * ã‚°ãƒ«ãƒ¼ãƒ—ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
 */
function toggleGroup(equipmentName) {
  const body = document.getElementById(`group-body-${equipmentName}`);
  const chevron = document.getElementById(`chevron-${equipmentName}`);
  
  if (body.classList.contains('hidden')) {
    body.classList.remove('hidden');
    chevron.classList.remove('fa-chevron-down');
    chevron.classList.add('fa-chevron-up');
  } else {
    body.classList.add('hidden');
    chevron.classList.remove('fa-chevron-up');
    chevron.classList.add('fa-chevron-down');
  }
}

/**
 * ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
 */
function toggleGroupCheckboxes(equipmentName) {
  const groupCheckbox = document.querySelector(`.group-checkbox[data-equipment="${equipmentName}"]`);
  const itemCheckboxes = document.querySelectorAll(`.equipment-check[data-equipment="${equipmentName}"]`);
  
  itemCheckboxes.forEach(function(cb) {
    cb.checked = groupCheckbox.checked;
  });
  
  updateBulkCount();
}

/**
 * å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ã«å¿œã˜ã¦ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ã‚’æ›´æ–°
 */
function updateGroupCheckbox(equipmentName) {
  const groupCheckbox = document.querySelector(`.group-checkbox[data-equipment="${equipmentName}"]`);
  const itemCheckboxes = document.querySelectorAll(`.equipment-check[data-equipment="${equipmentName}"]`);
  const checkedCount = Array.from(itemCheckboxes).filter(function(cb) { return cb.checked; }).length;
  
  if (checkedCount === 0) {
    groupCheckbox.checked = false;
    groupCheckbox.indeterminate = false;
  } else if (checkedCount === itemCheckboxes.length) {
    groupCheckbox.checked = true;
    groupCheckbox.indeterminate = false;
  } else {
    groupCheckbox.checked = false;
    groupCheckbox.indeterminate = true;
  }
}

/**
 * æ—¢å­˜æ¡ˆä»¶ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
 */
function generateExistingProjectOptions(locCode, eqId, locName) {
  if (!window.allProjects || window.allProjects.length === 0) {
    console.warn('âš ï¸ window.allProjects is empty');
    return '';
  }
  
  const sameLocationProjects = window.allProjects.filter(function(p) {
    return p.val && p.val.startsWith('EXISTING:') && p.locCode === locCode;
  });
  
  const otherProjects = window.allProjects.filter(function(p) {
    return p.val && p.val.startsWith('EXISTING:') && (!p.locCode || p.locCode !== locCode);
  });
  
  let options = '';
  
  if (sameLocationProjects.length > 0) {
    options += '<optgroup label="ã“ã®æ‹ ç‚¹ã®æ—¢å­˜æ¡ˆä»¶">';
    sameLocationProjects.forEach(function(p) {
      options += `<option value="${p.val}">${p.label}</option>`;
    });
    options += '</optgroup>';
  }
  
  if (otherProjects.length > 0) {
    options += '<optgroup label="ãã®ä»–ã®æ¡ˆä»¶">';
    otherProjects.slice(0, 10).forEach(function(p) {
      options += `<option value="${p.val}">${p.label}</option>`;
    });
    options += '</optgroup>';
  }
  
  return options;
}

/**
 * ä¸€æ‹¬ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
 */
function updateBulkCount() {
  const count = document.querySelectorAll('.import-check:checked').length;
  const countElement = document.getElementById('bulk-count');
  if (countElement) {
    countElement.textContent = count;
  }
  
  const bulkArea = document.getElementById('bulk-action-area');
  if (bulkArea) {
    if (count > 0) {
      bulkArea.classList.remove('hidden');
    } else {
      bulkArea.classList.add('hidden');
    }
  }
}

/**
 * ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œï¼ˆå—ä¿¡BOXãƒ»Driveç”¨ï¼‰
 */
function execBulkImport() {
  const checked = document.querySelectorAll('.import-check:checked');
  if (checked.length === 0) return;
  
  if (!confirm(`${checked.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²ã—ã€å‡¦ç†æ¸ˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  const targets = [];
  let error = false;

  checked.forEach(function(el) {
    const idx = el.dataset.idx;
    const file = currentFiles[idx];
    const select = document.querySelector(`.import-select[data-idx="${idx}"]`);
    const val = select.value;
    
    if (!val) {
      error = true;
      select.classList.add('border-red-500');
    } else {
      select.classList.remove('border-red-500');
      const parts = val.split(':');
      targets.push({
        fileId: file.id,
        projectType: parts[0],
        projectId: parts[0] === 'EXISTING' ? parts[1] : null,
        locCode: parts[0] === 'NEW' ? parts[1] : null,
        eqId: parts[0] === 'NEW' ? parts[2] : null
      });
    }
  });

  if (error) {
    alert('ç´ä»˜ã‘å…ˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™');
    return;
  }

  console.log('ğŸ“¤ Executing bulk import:', targets);
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(res) {
      console.log('âœ… execBulkImport success:', res);
      showLoading(false);
      alert(res.message);
      const activeTab = document.querySelector('button[id^="tab-"].text-blue-600');
      if (activeTab) {
        const tabName = activeTab.id.replace('tab-', '');
        if (tabName === 'inbox') {
          scanInbox();
        } else if (tabName === 'drive') {
          scanDrive();
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('âŒ execBulkImport failed:', error);
      showLoading(false);
      alert('ã‚¨ãƒ©ãƒ¼: ' + error);
    })
    .executeImport(targets);
}

/**
 * PCã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†ï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼‰
 */
function handleFileSelect(input) {
  const files = input.files;
  if (!files || files.length === 0) return;
  
  console.log('ğŸ“ Files selected:', files.length);
  
  uploadedFiles = [];
  
  Array.from(files).forEach(function(file) {
    if (file.type !== 'application/pdf') {
      alert(`${file.name} ã¯PDFãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
      return;
    }
    
    uploadedFiles.push({
      file: file,
      name: file.name,
      size: file.size,
      selected: true
    });
  });
  
  if (uploadedFiles.length === 0) {
    alert('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  renderUploadedFiles();
  updateUploadBulkCount();
}

/**
 * ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æç”»
 */
function renderUploadedFiles() {
  const container = document.getElementById('upload-preview');
  if (!container) return;
  
  container.innerHTML = '';
  container.classList.remove('hidden');
  
  uploadedFiles.forEach(function(fileData, index) {
    const card = document.createElement('div');
    card.className = 'bg-white p-4 border rounded shadow-sm mb-3';
    card.dataset.index = index;
    
    // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    let selectOptions = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    
    if (window.allProjects && window.allProjects.length > 0) {
      // æ–°è¦æ¡ˆä»¶ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const newProjects = window.allProjects.filter(function(p) { return p.isNew; });
      if (newProjects.length > 0) {
        selectOptions += '<optgroup label="æ–°è¦æ¡ˆä»¶ä½œæˆ">';
        newProjects.forEach(function(p) {
          selectOptions += `<option value="${p.val}">${p.label}</option>`;
        });
        selectOptions += '</optgroup>';
      }
      
      // æ—¢å­˜æ¡ˆä»¶ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const existingProjects = window.allProjects.filter(function(p) { return !p.isNew; });
      if (existingProjects.length > 0) {
        selectOptions += '<optgroup label="æ—¢å­˜æ¡ˆä»¶">';
        existingProjects.slice(0, 50).forEach(function(p) { // æœ€å¤§50ä»¶ã¾ã§è¡¨ç¤º
          selectOptions += `<option value="${p.val}">${p.label}</option>`;
        });
        selectOptions += '</optgroup>';
      }
    } else {
      console.warn('âš ï¸ window.allProjects is not ready yet');
      selectOptions += '<option value="" disabled>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</option>';
    }
    
    card.innerHTML = `
      <div class="flex justify-between items-center mb-3">
        <div class="flex-1">
          <div class="font-bold text-sm">${fileData.name}</div>
          <div class="text-xs text-gray-400 mt-1">${(fileData.size / 1024).toFixed(1)} KB</div>
        </div>
        <button onclick="removeUploadedFile(${index})" class="text-red-500 hover:text-red-700 ml-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div>
        <label class="text-xs font-bold text-gray-500 block mb-1">ç´ä»˜ã‘ã‚‹æ¡ˆä»¶ã‚’é¸æŠ</label>
        <select class="upload-project-select w-full border rounded p-2 text-sm bg-white" data-index="${index}">
          ${selectOptions}
        </select>
      </div>
    `;
    
    container.appendChild(card);
  });
}

/**
 * ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
 */
function removeUploadedFile(index) {
  uploadedFiles.splice(index, 1);
  if (uploadedFiles.length === 0) {
    document.getElementById('upload-preview').classList.add('hidden');
    document.getElementById('upload-bulk-action-area').classList.add('hidden');
    document.getElementById('file-input').value = '';
  } else {
    renderUploadedFiles();
    updateUploadBulkCount();
  }
}

/**
 * PCã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ä¸€æ‹¬ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
 */
function updateUploadBulkCount() {
  const count = uploadedFiles.length;
  const countElement = document.getElementById('upload-bulk-count');
  const bulkArea = document.getElementById('upload-bulk-action-area');
  
  if (countElement) {
    countElement.textContent = count;
  }
  
  if (bulkArea) {
    if (count > 0) {
      bulkArea.classList.remove('hidden');
    } else {
      bulkArea.classList.add('hidden');
    }
  }
}

/**
 * PCã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ä¸€æ‹¬ç™»éŒ²å®Ÿè¡Œ
 */
function execBulkUpload() {
  if (uploadedFiles.length === 0) return;
  
  // é¸æŠã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
  let hasError = false;
  uploadedFiles.forEach(function(fileData, index) {
    const select = document.querySelector(`.upload-project-select[data-index="${index}"]`);
    if (!select || !select.value) {
      hasError = true;
      select.classList.add('border-red-500');
    } else {
      select.classList.remove('border-red-500');
    }
  });
  
  if (hasError) {
    alert('ç´ä»˜ã‘å…ˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™');
    return;
  }
  
  if (!confirm(`${uploadedFiles.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²ã—ã€å‡¦ç†æ¸ˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  
  console.log('ğŸ“¤ Executing bulk upload:', uploadedFiles.length, 'files');
  showLoading(true);
  
  let completed = 0;
  let errors = [];
  
  uploadedFiles.forEach(function(fileData, index) {
    const select = document.querySelector(`.upload-project-select[data-index="${index}"]`);
    const val = select.value;
    const parts = val.split(':');
    
    const projectInfo = {
      type: parts[0],
      id: parts[0] === 'EXISTING' ? parts[1] : null,
      locCode: parts[0] === 'NEW' ? parts[1] : null,
      eqId: parts[0] === 'NEW' ? parts[2] : null
    };
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64 = e.target.result.split(',')[1];
      
      google.script.run
        .withSuccessHandler(function(res) {
          completed++;
          console.log(`âœ… Upload ${index + 1}/${uploadedFiles.length} completed`);
          
          if (completed === uploadedFiles.length) {
            showLoading(false);
            if (errors.length > 0) {
              alert(`${completed}ä»¶å‡¦ç†å®Œäº†\nâš ï¸ ${errors.length}ä»¶ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
            } else {
              alert(`${completed}ä»¶ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ`);
            }
            
            // ãƒªã‚»ãƒƒãƒˆ
            uploadedFiles = [];
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('upload-bulk-action-area').classList.add('hidden');
            document.getElementById('file-input').value = '';
          }
        })
        .withFailureHandler(function(error) {
          completed++;
          errors.push(`${fileData.name}: ${error}`);
          console.error(`âŒ Upload ${index + 1} failed:`, error);
          
          if (completed === uploadedFiles.length) {
            showLoading(false);
            if (errors.length > 0) {
              alert(`${completed}ä»¶å‡¦ç†å®Œäº†\nâš ï¸ ${errors.length}ä»¶ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
            } else {
              alert(`${completed}ä»¶ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ`);
            }
            
            uploadedFiles = [];
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('upload-bulk-action-area').classList.add('hidden');
            document.getElementById('file-input').value = '';
          }
        })
        .uploadAndImport(base64, fileData.name, fileData.file.type, projectInfo);
    };
    
    reader.onerror = function() {
      completed++;
      errors.push(`${fileData.name}: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼`);
      
      if (completed === uploadedFiles.length) {
        showLoading(false);
        alert(`${completed}ä»¶å‡¦ç†å®Œäº†\nâš ï¸ ${errors.length}ä»¶ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
        
        uploadedFiles = [];
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('upload-bulk-action-area').classList.add('hidden');
        document.getElementById('file-input').value = '';
      }
    };
    
    reader.readAsDataURL(fileData.file);
  });
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
console.log('ğŸ”„ Page loaded, initializing...');
if (typeof importInit === 'function') {
  importInit();
} else {
  console.error('âŒ importInit function not found');
}
</script>
