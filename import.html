<div class="space-y-6">
  <div class="flex justify-between items-center border-b pb-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-file-import mr-2"></i>見積・資料インポート</h2>
      <p class="text-sm text-gray-600">PDF見積書を取り込み、案件と紐付けて整理します。</p>
    </div>
  </div>

  <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
    <button onclick="switchTab('inbox')" id="tab-inbox" class="flex-1 py-2 px-4 rounded-md text-sm font-bold bg-white shadow text-blue-600 transition">
      <i class="fas fa-inbox mr-2"></i>受信BOX (自動検知)
    </button>
    <button onclick="switchTab('drive')" id="tab-drive" class="flex-1 py-2 px-4 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200 transition">
      <i class="fab fa-google-drive mr-2"></i>Driveフォルダ指定
    </button>
    <button onclick="switchTab('local')" id="tab-local" class="flex-1 py-2 px-4 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200 transition">
      <i class="fas fa-laptop mr-2"></i>PCからアップロード
    </button>
  </div>

  <div id="area-inbox" class="tab-content">
    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4 flex justify-between items-center">
      <div>
        <h3 class="font-bold text-blue-800">SS見積_受信BOX</h3>
        <p class="text-xs text-blue-600">Gmail等の添付ファイルをこのフォルダに入れてください。</p>
      </div>
      <button onclick="scanInbox()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow">
        <i class="fas fa-sync-alt mr-1"></i> 再スキャン
      </button>
    </div>
    <div id="inbox-list" class="space-y-2">
      <div class="p-8 text-center text-gray-400">スキャン中...</div>
    </div>
  </div>

  <div id="area-drive" class="tab-content hidden">
    <div class="bg-white border rounded p-6 text-center">
      <p class="mb-4 text-sm text-gray-600">過去の見積書が保存されているDriveフォルダIDを入力してください。</p>
      <div class="flex max-w-lg mx-auto gap-2">
        <input type="text" id="drive-folder-id" class="flex-1 border rounded p-2 text-sm" placeholder="フォルダID (URLの末尾部分)">
        <button onclick="scanDrive()" class="bg-gray-700 text-white px-6 py-2 rounded font-bold hover:bg-gray-800">
          <i class="fas fa-search mr-1"></i> 検索
        </button>
      </div>
    </div>
    <div id="drive-list" class="space-y-2 mt-4"></div>
  </div>

  <div id="area-local" class="tab-content hidden">
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center bg-gray-50 hover:bg-gray-100 transition relative" id="drop-zone">
      <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
      <div class="pointer-events-none">
        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
        <p class="font-bold text-gray-600">ここにファイルをドラッグ&ドロップ</p>
        <p class="text-xs text-gray-400 mt-1">またはクリックして選択 (PDFのみ)</p>
      </div>
    </div>
    <div id="upload-preview" class="mt-4 hidden">
      <div class="bg-white p-4 border rounded shadow-sm">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold" id="upload-filename"></span>
          <span class="text-xs text-gray-400" id="upload-size"></span>
        </div>
        <div class="mb-2">
          <label class="text-xs font-bold text-gray-500">紐付ける案件を選択</label>
          <select id="upload-project-select" class="w-full border rounded p-2 mt-1"></select>
        </div>
        <button onclick="execUpload()" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 shadow">
          アップロードして登録
        </button>
      </div>
    </div>
  </div>

  <div id="bulk-action-area" class="hidden fixed bottom-6 right-6 z-50">
    <button onclick="execBulkImport()" class="bg-green-600 text-white px-8 py-4 rounded-full shadow-lg font-bold hover:bg-green-700 flex items-center transform transition hover:scale-105">
      <i class="fas fa-check-circle text-xl mr-2"></i>
      <span id="bulk-count">0</span>件を登録して整理
    </button>
  </div>
</div>

<script>
let currentFiles = []; 
let allProjects = []; 

function importInit() {
  // 既存案件を取得（詳細情報を含む）
  google.script.run
    .withSuccessHandler(projects => {
      // 既存案件の詳細情報を保持
      const existingProjects = projects.map(item => {
        // 案件IDの短縮版を作成（表示用）
        const shortId = item.id ? item.id.substring(0, 8) : '';
        
        return {
          val: `EXISTING:${item.id}`,
          label: `案件#${shortId}: ${item.locName} - ${item.equipmentName || item.equipmentId} - ${item.workType}`,
          locCode: item.locCode,
          id: item.id
        };
      });
      
      // 設備一覧も取得（新規案件用）
      google.script.run
        .withSuccessHandler(list => {
          // 新規案件用のデータも保持
          const newProjectOptions = list.map(item => ({
            val: `NEW:${item['拠点コード']}:${item['設備ID']}`,
            label: `【新規】${item['拠点名']} - ${item['設備名']}`,
            locCode: item['拠点コード']
          }));
          
          // allProjectsに統合
          allProjects = [...existingProjects, ...newProjectOptions];
          
          scanInbox();
        })
        .getEquipmentList();
    })
    .getAllActiveProjects();
}

function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('area-' + tab).classList.remove('hidden');
  document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
    btn.classList.remove('bg-white', 'shadow', 'text-blue-600');
    btn.classList.add('text-gray-500', 'hover:bg-gray-200');
  });
  const activeBtn = document.getElementById('tab-' + tab);
  activeBtn.classList.remove('text-gray-500', 'hover:bg-gray-200');
  activeBtn.classList.add('bg-white', 'shadow', 'text-blue-600');
}

function scanInbox() {
  showLoading(true);
  document.getElementById('inbox-list').innerHTML = '<div class="p-4 text-center">スキャン中...</div>';
  google.script.run.withSuccessHandler(renderFiles).scanInboxFiles();
}

function scanDrive() {
  const id = document.getElementById('drive-folder-id').value;
  if(!id) return alert('フォルダIDを入力してください');
  showLoading(true);
  google.script.run.withSuccessHandler(res => {
    if(!res.success) { showLoading(false); alert(res.error); return; }
    renderFiles(res);
  }).scanDriveFolder(id);
}

function renderFiles(res) {
  showLoading(false);
  const container = document.querySelector('.tab-content:not(.hidden) div[id$="-list"]');
  container.innerHTML = '';
  
  if (res.files.length === 0) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">PDFファイルは見つかりませんでした</div>';
    document.getElementById('bulk-action-area').classList.add('hidden');
    return;
  }

  currentFiles = res.files;

  // ========================================
  // 【重要】案件化済み/未案件化に分類
  // ========================================
  
  // Step 1: 案件化済み/未案件化に分類
  const existingProjects = []; // 既存案件
  const newEquipments = {};     // 新規（設備種別でグループ化）
  
  res.files.forEach((file, idx) => {
    if (file.suggestion) {
      if (file.suggestion.type === 'EXISTING') {
        // 既存案件
        existingProjects.push({
          file: file,
          idx: idx,
          projectId: file.suggestion.id,
          label: file.suggestion.label,
          detailLabel: file.suggestion.detailLabel || file.suggestion.label
        });
      } else if (file.suggestion.type === 'NEW') {
        // 新規案件 - 設備名でグループ化
        const equipmentName = getBaseEquipmentName(file.suggestion.eqName);
        
        if (!newEquipments[equipmentName]) {
          newEquipments[equipmentName] = [];
        }
        
        newEquipments[equipmentName].push({
          file: file,
          idx: idx,
          locCode: file.suggestion.locCode,
          locName: file.suggestion.locName,
          eqId: file.suggestion.eqId,
          eqName: file.suggestion.eqName
        });
      }
    }
  });

  // Step 2: 案件化済みセクションを描画
  if (existingProjects.length > 0) {
    const section = createSectionHeader('案件化済み', existingProjects.length, 'blue');
    container.appendChild(section);
    
    existingProjects.forEach(item => {
      const div = createExistingProjectItem(item);
      container.appendChild(div);
    });
  }

  // Step 3: 新規案件セクションを描画
  if (Object.keys(newEquipments).length > 0) {
    const totalNew = Object.values(newEquipments).reduce((sum, items) => sum + items.length, 0);
    const section = createSectionHeader('新規案件', totalNew, 'green');
    container.appendChild(section);
    
    // 設備種別ごとにグループ表示
    Object.keys(newEquipments).sort().forEach(equipmentName => {
      const items = newEquipments[equipmentName];
      const div = createNewEquipmentGroup(equipmentName, items);
      container.appendChild(div);
    });
  }

  updateBulkCount();
}

/**
 * 設備名から基本名を抽出（括弧を除去）
 */
function getBaseEquipmentName(equipmentName) {
  if (!equipmentName) return '不明な設備';
  // 括弧とその中身を削除
  return equipmentName.replace(/[(\(（].*?[)\)）]/g, '').trim();
}

/**
 * セクションヘッダーを作成
 */
/**
 * セクションヘッダーを作成
 */
function createSectionHeader(title, count, color) {
  const section = document.createElement('div');
  // Tailwindの動的クラス名を避けて、固定クラス名を使用
  let className, badgeClassName;
  if (color === 'blue') {
    className = 'bg-blue-50 border-blue-200 border-b-2 p-3 font-bold text-blue-800 flex items-center gap-2';
    badgeClassName = 'text-xs bg-blue-100 px-2 py-1 rounded';
  } else if (color === 'green') {
    className = 'bg-green-50 border-green-200 border-b-2 p-3 font-bold text-green-800 flex items-center gap-2';
    badgeClassName = 'text-xs bg-green-100 px-2 py-1 rounded';
  } else {
    className = 'bg-gray-50 border-gray-200 border-b-2 p-3 font-bold text-gray-800 flex items-center gap-2';
    badgeClassName = 'text-xs bg-gray-100 px-2 py-1 rounded';
  }
  
  section.className = className;
  section.innerHTML = `
    <i class="fas fa-folder-open"></i>
    <span>${title}</span>
    <span class="${badgeClassName}">${count}件</span>
  `;
  return section;
}

/**
 * 既存案件アイテムを作成
 */
function createExistingProjectItem(item) {
  const div = document.createElement('div');
  div.className = "bg-white p-3 border-b flex items-center gap-3 hover:bg-blue-50";
  
  // detailLabelを使用して詳細表示（設備名を含む）
  const displayLabel = item.detailLabel || item.label;
  
  div.innerHTML = `
    <input type="checkbox" 
           class="import-check w-5 h-5 accent-blue-600" 
           data-idx="${item.idx}" 
           checked
           onchange="updateBulkCount()">
    <div class="flex-1 min-w-0">
      <div class="font-bold text-sm text-blue-600">
        <i class="fas fa-link mr-1"></i>${displayLabel}
      </div>
      <div class="text-xs text-gray-500 mt-1">
        <a href="${item.file.url}" target="_blank" class="hover:underline">
          <i class="fas fa-file-pdf mr-1"></i>${item.file.name}
        </a>
      </div>
    </div>
    <select class="border rounded p-1 text-sm import-select bg-white" data-idx="${item.idx}">
      <option value="EXISTING:${item.projectId}" selected>この案件に紐付け</option>
    </select>
  `;
  
  return div;
}

/**
 * 新規設備グループを作成
 */
function createNewEquipmentGroup(equipmentName, items) {
  const groupDiv = document.createElement('div');
  groupDiv.className = "border-b";
  
  // グループヘッダー
  const header = document.createElement('div');
  header.className = "bg-green-50 p-3 flex items-center gap-3 cursor-pointer hover:bg-green-100";
  header.onclick = () => toggleGroup(equipmentName);
  
  const storeList = items.map(i => i.locName).join('、');
  const storeCount = items.length;
  
  header.innerHTML = `
    <input type="checkbox" 
           class="group-checkbox w-5 h-5 accent-green-600" 
           data-equipment="${equipmentName}"
           onchange="toggleGroupCheckboxes('${equipmentName}')"
           onclick="event.stopPropagation()"
           checked>
    <div class="flex-1">
      <div class="font-bold text-sm text-green-800">
        <i class="fas fa-wrench mr-1"></i>新規: ${equipmentName}更新
      </div>
      <div class="text-xs text-green-600 mt-1">
        該当: ${storeCount}店舗（${storeList}）
      </div>
    </div>
    <i class="fas fa-chevron-up text-gray-400" id="chevron-${equipmentName}"></i>
  `;
  
  // グループボディ（折りたたみ可能、初期状態は展開）
  const body = document.createElement('div');
  body.id = `group-body-${equipmentName}`;
  body.className = "bg-gray-50";
  
  items.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = "p-3 pl-12 border-t flex items-center gap-3 hover:bg-white";
    
    // ドロップダウンに複数の選択肢を追加
    const selectOptions = generateExistingProjectOptions(item.locCode, item.eqId, item.locName);
    
    itemDiv.innerHTML = `
      <input type="checkbox" 
             class="import-check equipment-check w-4 h-4 accent-green-600" 
             data-idx="${item.idx}"
             data-equipment="${equipmentName}"
             checked
             onchange="updateBulkCount(); updateGroupCheckbox('${equipmentName}')">
      <div class="flex-1 text-sm">
        <span class="font-bold">${item.locName}</span>
        <a href="${item.file.url}" target="_blank" class="text-xs text-gray-500 ml-2 hover:underline">
          <i class="fas fa-file-pdf mr-1"></i>${item.file.name}
        </a>
      </div>
      <select class="border rounded p-1 text-xs import-select bg-white" data-idx="${item.idx}">
        <option value="NEW:${item.locCode}:${item.eqId}" selected>新規案件作成</option>
        <option disabled>─────────────────</option>
        ${selectOptions}
      </select>
    `;
    
    body.appendChild(itemDiv);
  });
  
  groupDiv.appendChild(header);
  groupDiv.appendChild(body);
  
  return groupDiv;
}

/**
 * グループの展開/折りたたみ
 */
function toggleGroup(equipmentName) {
  const body = document.getElementById(`group-body-${equipmentName}`);
  const chevron = document.getElementById(`chevron-${equipmentName}`);
  
  if (body.classList.contains('hidden')) {
    body.classList.remove('hidden');
    chevron.classList.remove('fa-chevron-down');
    chevron.classList.add('fa-chevron-up');
  } else {
    body.classList.add('hidden');
    chevron.classList.remove('fa-chevron-up');
    chevron.classList.add('fa-chevron-down');
  }
}

/**
 * グループ内の全チェックボックスを切り替え
 */
function toggleGroupCheckboxes(equipmentName) {
  const groupCheckbox = document.querySelector(`.group-checkbox[data-equipment="${equipmentName}"]`);
  const itemCheckboxes = document.querySelectorAll(`.equipment-check[data-equipment="${equipmentName}"]`);
  
  itemCheckboxes.forEach(cb => {
    cb.checked = groupCheckbox.checked;
  });
  
  updateBulkCount();
}

/**
 * 個別チェックに応じてグループチェックを更新
 */
function updateGroupCheckbox(equipmentName) {
  const groupCheckbox = document.querySelector(`.group-checkbox[data-equipment="${equipmentName}"]`);
  const itemCheckboxes = document.querySelectorAll(`.equipment-check[data-equipment="${equipmentName}"]`);
  const checkedCount = Array.from(itemCheckboxes).filter(cb => cb.checked).length;
  
  if (checkedCount === 0) {
    groupCheckbox.checked = false;
    groupCheckbox.indeterminate = false;
  } else if (checkedCount === itemCheckboxes.length) {
    groupCheckbox.checked = true;
    groupCheckbox.indeterminate = false;
  } else {
    groupCheckbox.checked = false;
    groupCheckbox.indeterminate = true;
  }
}

/**
 * 既存案件の選択肢を生成（同じ拠点の案件を優先表示）
 */
function generateExistingProjectOptions(locCode, eqId, locName) {
  if (!allProjects || allProjects.length === 0) return '';
  
  // 同じ拠点の案件を抽出
  const sameLocationProjects = allProjects.filter(p => 
    p.val && p.val.startsWith('EXISTING:') && p.locCode === locCode
  );
  
  // その他の案件を抽出
  const otherProjects = allProjects.filter(p => 
    p.val && p.val.startsWith('EXISTING:') && (!p.locCode || p.locCode !== locCode)
  );
  
  let options = '';
  
  if (sameLocationProjects.length > 0) {
    options += '<optgroup label="この拠点の既存案件">';
    sameLocationProjects.forEach(p => {
      options += `<option value="${p.val}">${p.label}</option>`;
    });
    options += '</optgroup>';
  }
  
  if (otherProjects.length > 0) {
    options += '<optgroup label="その他の案件">';
    otherProjects.slice(0, 10).forEach(p => { // 最大10件まで表示
      options += `<option value="${p.val}">${p.label}</option>`;
    });
    options += '</optgroup>';
  }
  
  return options;
}

function updateBulkCount() {
  const count = document.querySelectorAll('.import-check:checked').length;
  document.getElementById('bulk-count').innerText = count;
  if(count > 0) document.getElementById('bulk-action-area').classList.remove('hidden');
  else document.getElementById('bulk-action-area').classList.add('hidden');
}

function execBulkImport() {
  const checked = document.querySelectorAll('.import-check:checked');
  if(checked.length === 0) return;
  if(!confirm(`${checked.length}件のファイルを登録し、処理済フォルダに移動しますか？`)) return;

  const targets = [];
  let error = false;

  checked.forEach(el => {
    const idx = el.dataset.idx;
    const file = currentFiles[idx];
    const select = document.querySelector(`.import-select[data-idx="${idx}"]`);
    const val = select.value;
    
    if (!val) { error = true; select.classList.add('border-red-500'); }
    else {
      select.classList.remove('border-red-500');
      const parts = val.split(':');
      targets.push({
        fileId: file.id,
        projectType: parts[0],
        projectId: parts[0]==='EXISTING'?parts[1]:null,
        locCode: parts[0]==='NEW'?parts[1]:null,
        eqId: parts[0]==='NEW'?parts[2]:null
      });
    }
  });

  if (error) return alert('紐付け先が選択されていないファイルがあります');

  showLoading(true);
  google.script.run.withSuccessHandler(res => {
    showLoading(false);
    alert(res.message);
    const activeTab = document.querySelector('button[id^="tab-"].text-blue-600').id.replace('tab-', '');
    if(activeTab === 'inbox') scanInbox();
    else if(activeTab === 'drive') scanDrive();
  }).executeImport(targets);
}

let uploadFile = null;

function handleFileSelect(input) {
  const file = input.files[0];
  if (!file || file.type !== 'application/pdf') return alert('PDFファイルを選択してください');
  
  uploadFile = file;
  document.getElementById('upload-preview').classList.remove('hidden');
  document.getElementById('upload-filename').innerText = file.name;
  document.getElementById('upload-size').innerText = (file.size/1024).toFixed(1) + ' KB';
  
  const sel = document.getElementById('upload-project-select');
  sel.innerHTML = '<option value="">選択してください</option>';
  allProjects.forEach(p => {
    const op = document.createElement('option');
    op.value = p.val;
    op.innerText = p.label;
    sel.appendChild(op);
  });
}

function execUpload() {
  const sel = document.getElementById('upload-project-select');
  if(!sel.value) return alert('案件を選択してください');
  if(!uploadFile) return;

  const parts = sel.value.split(':');
  const projectInfo = {
    type: parts[0],
    id: parts[0]==='EXISTING'?parts[1]:null,
    locCode: parts[0]==='NEW'?parts[1]:null,
    eqId: parts[0]==='NEW'?parts[2]:null
  };

  showLoading(true);
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result.split(',')[1];
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      alert('アップロードと登録が完了しました');
      document.getElementById('upload-preview').classList.add('hidden');
      uploadFile = null;
    }).uploadAndImport(base64, uploadFile.name, uploadFile.type, projectInfo);
  };
  reader.readAsDataURL(uploadFile);
}
</script>