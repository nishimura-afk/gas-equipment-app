<div class="space-y-6">
  <div class="flex justify-between items-center border-b pb-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-file-import mr-2"></i>è¦‹ç©ãƒ»è³‡æ–™ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
      <p class="text-sm text-gray-600">PDFè¦‹ç©æ›¸ã‚’å–ã‚Šè¾¼ã¿ã€æ¡ˆä»¶ã¨ç´ä»˜ã‘ã¦æ•´ç†ã—ã¾ã™ã€‚</p>
    </div>
  </div>

  <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
    <button onclick="switchTab('inbox')" id="tab-inbox" class="flex-1 py-2 px-4 rounded-md text-sm font-bold bg-white shadow text-blue-600 transition">
      <i class="fas fa-inbox mr-2"></i>å—ä¿¡BOX (è‡ªå‹•æ¤œçŸ¥)
    </button>
    <button onclick="switchTab('drive')" id="tab-drive" class="flex-1 py-2 px-4 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200 transition">
      <i class="fab fa-google-drive mr-2"></i>Driveãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®š
    </button>
    <button onclick="switchTab('local')" id="tab-local" class="flex-1 py-2 px-4 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200 transition">
      <i class="fas fa-laptop mr-2"></i>PCã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>

  <div id="area-inbox" class="tab-content">
    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4 flex justify-between items-center">
      <div>
        <h3 class="font-bold text-blue-800">SSè¦‹ç©_å—ä¿¡BOX</h3>
        <p class="text-xs text-blue-600">Gmailç­‰ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
      </div>
      <button onclick="scanInbox()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow">
        <i class="fas fa-sync-alt mr-1"></i> å†ã‚¹ã‚­ãƒ£ãƒ³
      </button>
    </div>
    <div id="inbox-list" class="space-y-2">
      <div class="p-8 text-center text-gray-400">ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</div>
    </div>
  </div>

  <div id="area-drive" class="tab-content hidden">
    <div class="bg-white border rounded p-6 text-center">
      <p class="mb-4 text-sm text-gray-600">éå»ã®è¦‹ç©æ›¸ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹Driveãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <div class="flex max-w-lg mx-auto gap-2">
        <input type="text" id="drive-folder-id" class="flex-1 border rounded p-2 text-sm" placeholder="ãƒ•ã‚©ãƒ«ãƒ€ID (URLã®æœ«å°¾éƒ¨åˆ†)">
        <button onclick="scanDrive()" class="bg-gray-700 text-white px-6 py-2 rounded font-bold hover:bg-gray-800">
          <i class="fas fa-search mr-1"></i> æ¤œç´¢
        </button>
      </div>
    </div>
    <div id="drive-list" class="space-y-2 mt-4"></div>
  </div>

  <div id="area-local" class="tab-content hidden">
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center bg-gray-50 hover:bg-gray-100 transition relative" id="drop-zone">
      <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
      <div class="pointer-events-none">
        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
        <p class="font-bold text-gray-600">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
        <p class="text-xs text-gray-400 mt-1">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ (PDFã®ã¿)</p>
      </div>
    </div>
    <div id="upload-preview" class="mt-4 hidden">
      <div class="bg-white p-4 border rounded shadow-sm">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold" id="upload-filename"></span>
          <span class="text-xs text-gray-400" id="upload-size"></span>
        </div>
        <div class="mb-2">
          <label class="text-xs font-bold text-gray-500">ç´ä»˜ã‘ã‚‹æ¡ˆä»¶ã‚’é¸æŠ</label>
          <select id="upload-project-select" class="w-full border rounded p-2 mt-1"></select>
        </div>
        <button onclick="execUpload()" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 shadow">
          ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ç™»éŒ²
        </button>
      </div>
    </div>
  </div>

  <div id="bulk-action-area" class="hidden fixed bottom-6 right-6 z-50">
    <button onclick="execBulkImport()" class="bg-green-600 text-white px-8 py-4 rounded-full shadow-lg font-bold hover:bg-green-700 flex items-center transform transition hover:scale-105">
      <i class="fas fa-check-circle text-xl mr-2"></i>
      <span id="bulk-count">0</span>ä»¶ã‚’ç™»éŒ²ã—ã¦æ•´ç†
    </button>
  </div>
</div>

<script>
let currentFiles = []; 
let allProjects = []; 

function importInit() {
  // æ—¢å­˜æ¡ˆä»¶ã‚’å–å¾—
  google.script.run.withSuccessHandler(projects => {
    // æ–°è¦æ¡ˆä»¶å€™è£œã‚’å–å¾—
    google.script.run.withSuccessHandler(list => {
      // æ—¢å­˜æ¡ˆä»¶ã¨æ–°è¦æ¡ˆä»¶ã‚’ä¿å­˜ï¼ˆéšå±¤åŒ–ç”¨ï¼‰
      allProjects = {
        existing: projects,
        new: list
      };
      
      scanInbox();
    }).getEquipmentList();
  }).getAllActiveProjects();
}

/**
 * ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³HTMLã‚’ç”Ÿæˆï¼ˆæ‹ ç‚¹ã”ã¨ã«éšå±¤åŒ–ï¼‰
 * æ³¨: optgroupã®ãƒã‚¹ãƒˆã¯ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€
 * ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰ã§éšå±¤ã‚’è¡¨ç¾ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆã‚’ä½¿ç”¨
 */
function buildProjectDropdown(fileName) {
  let html = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
  
  // æ—¢å­˜æ¡ˆä»¶ã‚’æ‹ ç‚¹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const projectsByLocation = {};
  
  if (allProjects.existing && allProjects.existing.length > 0) {
    allProjects.existing.forEach(project => {
      const locationName = project.locName || 'ä¸æ˜';
      if (!projectsByLocation[locationName]) {
        projectsByLocation[locationName] = [];
      }
      projectsByLocation[locationName].push(project);
    });
    
    // æ‹ ç‚¹åã§ã‚½ãƒ¼ãƒˆ
    const sortedLocations = Object.keys(projectsByLocation).sort();
    
    if (sortedLocations.length > 0) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆ: optgroupã®ãƒã‚¹ãƒˆã§ã¯ãªãã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã§éšå±¤ã‚’è¡¨ç¾
      html += '<option disabled>ğŸ“ æ—¢å­˜æ¡ˆä»¶</option>';
      
      sortedLocations.forEach(locationName => {
        html += `<option disabled>ã€€${locationName}</option>`;
        
        projectsByLocation[locationName].forEach(project => {
          const label = `ã€€ã€€${project.equipmentName || project.equipmentId || ''} (${project.workType || ''})`;
          html += `<option value="EXISTING:${project.id}">${label}</option>`;
        });
      });
    }
  }
  
  // åŒºåˆ‡ã‚Šç·š
  html += '<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>';
  
  // æ–°è¦æ¡ˆä»¶ã¨ã—ã¦ç™»éŒ²
  html += '<option value="NEW_PROJECT">âœ¨ æ–°è¦æ¡ˆä»¶ã¨ã—ã¦ç™»éŒ²</option>';
  
  // æ¡ˆä»¶ãªã—
  html += '<option value="NO_PROJECT">ğŸ’¡ æ¡ˆä»¶ãªã—</option>';
  
  return html;
}

function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('area-' + tab).classList.remove('hidden');
  document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
    btn.classList.remove('bg-white', 'shadow', 'text-blue-600');
    btn.classList.add('text-gray-500', 'hover:bg-gray-200');
  });
  const activeBtn = document.getElementById('tab-' + tab);
  activeBtn.classList.remove('text-gray-500', 'hover:bg-gray-200');
  activeBtn.classList.add('bg-white', 'shadow', 'text-blue-600');
}

function scanInbox() {
  showLoading(true);
  document.getElementById('inbox-list').innerHTML = '<div class="p-4 text-center">ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</div>';
  google.script.run.withSuccessHandler(renderFiles).scanInboxFiles();
}

function scanDrive() {
  const id = document.getElementById('drive-folder-id').value;
  if(!id) return alert('ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  showLoading(true);
  google.script.run.withSuccessHandler(res => {
    if(!res.success) { showLoading(false); alert(res.error); return; }
    renderFiles(res);
  }).scanDriveFolder(id);
}

function renderFiles(res) {
  showLoading(false);
  const container = document.querySelector('.tab-content:not(.hidden) div[id$="-list"]');
  container.innerHTML = '';
  
  if (res.files.length === 0) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">PDFãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
    document.getElementById('bulk-action-area').classList.add('hidden');
    return;
  }

  currentFiles = res.files; 

  res.files.forEach((file, idx) => {
    const div = document.createElement('div');
    div.className = "bg-white p-3 rounded border flex items-center justify-between hover:bg-gray-50";
    
    let selectHtml = `<select class="border rounded p-1 text-sm max-w-xs import-select" data-idx="${idx}">`;
    
    // æ¨å¥¨æ¡ˆä»¶ãŒã‚ã‚‹å ´åˆã¯æœ€åˆã«è¡¨ç¤º
    if (file.suggestion) {
      const val = (file.suggestion.type === 'NEW') 
        ? `NEW:${file.suggestion.locCode}:${file.suggestion.eqId}`
        : `EXISTING:${file.suggestion.id}`;
      selectHtml += `<option value="${val}" selected>ğŸ’¡ ${file.suggestion.label}</option>`;
      selectHtml += `<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>`;
    }
    
    // éšå±¤åŒ–ã•ã‚ŒãŸãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
    selectHtml += buildProjectDropdown(file.name);
    selectHtml += `</select>`;

    div.innerHTML = `
      <div class="flex items-center gap-3 overflow-hidden">
        <input type="checkbox" class="import-check w-5 h-5 accent-blue-600" data-idx="${idx}" ${file.suggestion ? 'checked' : ''} onchange="updateBulkCount()">
        <div class="min-w-0">
          <div class="font-bold truncate text-sm"><a href="${file.url}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf mr-1"></i>${file.name}</a></div>
          <div class="text-xs text-gray-400">${file.lastUpdated}</div>
        </div>
      </div>
      <div>${selectHtml}</div>
    `;
    container.appendChild(div);
  });
  
  updateBulkCount();
}

function updateBulkCount() {
  const count = document.querySelectorAll('.import-check:checked').length;
  document.getElementById('bulk-count').innerText = count;
  if(count > 0) document.getElementById('bulk-action-area').classList.remove('hidden');
  else document.getElementById('bulk-action-area').classList.add('hidden');
}

function execBulkImport() {
  const checked = document.querySelectorAll('.import-check:checked');
  if(checked.length === 0) return;
  if(!confirm(`${checked.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²ã—ã€å‡¦ç†æ¸ˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  const targets = [];
  let error = false;

  checked.forEach(el => {
    const idx = el.dataset.idx;
    const file = currentFiles[idx];
    const select = document.querySelector(`.import-select[data-idx="${idx}"]`);
    const val = select.value;
    
    if (!val) { error = true; select.classList.add('border-red-500'); }
    else {
      select.classList.remove('border-red-500');
      
      if (val === 'NO_PROJECT') {
        targets.push({
          fileId: file.id,
          projectType: 'NONE',
          projectId: null,
          locCode: null,
          eqId: null
        });
      } else if (val === 'NEW_PROJECT') {
        // æ–°è¦æ¡ˆä»¶ã¨ã—ã¦ç™»éŒ²ã™ã‚‹å ´åˆ
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ¨æ¸¬ã—ã¦æ¡ˆä»¶ã‚’ä½œæˆ
        targets.push({
          fileId: file.id,
          projectType: 'NEW_PROJECT',
          projectId: null,
          locCode: null,
          eqId: null,
          fileName: file.name
        });
      } else {
        const parts = val.split(':');
        targets.push({
          fileId: file.id,
          projectType: parts[0],
          projectId: parts[0]==='EXISTING'?parts[1]:null,
          locCode: parts[0]==='NEW'?parts[1]:null,
          eqId: parts[0]==='NEW'?parts[2]:null
        });
      }
    }
  });

  if (error) return alert('ç´ä»˜ã‘å…ˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™');

  showLoading(true);
  google.script.run.withSuccessHandler(res => {
    showLoading(false);
    alert(res.message);
    const activeTab = document.querySelector('button[id^="tab-"].text-blue-600').id.replace('tab-', '');
    if(activeTab === 'inbox') scanInbox();
    else if(activeTab === 'drive') scanDrive();
  }).executeImport(targets);
}

let uploadFile = null;

function handleFileSelect(input) {
  const file = input.files[0];
  if (!file || file.type !== 'application/pdf') return alert('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
  
  uploadFile = file;
  document.getElementById('upload-preview').classList.remove('hidden');
  document.getElementById('upload-filename').innerText = file.name;
  document.getElementById('upload-size').innerText = (file.size/1024).toFixed(1) + ' KB';
  
  const sel = document.getElementById('upload-project-select');
  sel.innerHTML = buildProjectDropdown(uploadFile.name);
}

function execUpload() {
  const sel = document.getElementById('upload-project-select');
  if(!sel.value) return alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
  if(!uploadFile) return;

  let projectInfo;
  if (sel.value === 'NO_PROJECT') {
    projectInfo = {
      type: 'NONE',
      id: null,
      locCode: null,
      eqId: null
    };
  } else if (sel.value === 'NEW_PROJECT') {
    // æ–°è¦æ¡ˆä»¶ã¨ã—ã¦ç™»éŒ²ã™ã‚‹å ´åˆ
    projectInfo = {
      type: 'NEW_PROJECT',
      id: null,
      locCode: null,
      eqId: null,
      fileName: uploadFile.name
    };
  } else {
    const parts = sel.value.split(':');
    projectInfo = {
      type: parts[0],
      id: parts[0]==='EXISTING'?parts[1]:null,
      locCode: parts[0]==='NEW'?parts[1]:null,
      eqId: parts[0]==='NEW'?parts[2]:null
    };
  }

  showLoading(true);
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result.split(',')[1];
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ');
      document.getElementById('upload-preview').classList.add('hidden');
      uploadFile = null;
    }).uploadAndImport(base64, uploadFile.name, uploadFile.type, projectInfo);
  };
  reader.readAsDataURL(uploadFile);
}
</script>