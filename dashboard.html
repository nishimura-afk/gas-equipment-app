<!-- Dashboard View -->
<div class="space-y-8">
  <div class="flex justify-between items-center border-b pb-4">
    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-pie mr-2"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <button onclick="dashboardInit(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition shadow">
      <i class="fas fa-sync-alt mr-1"></i> æ›´æ–°
    </button>
  </div>

  <!-- ä¸Šæ®µ: æ³•å®šæ¤œæŸ» -->
  <div class="bg-white rounded-lg border-2 border-indigo-200 shadow-md overflow-hidden">
    <div class="bg-indigo-50 p-3 border-b border-indigo-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-indigo-800"><i class="fas fa-balance-scale mr-2"></i>ã€æœ€å„ªå…ˆã€‘æ³•å®šæ¤œæŸ»</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-indigo-600 font-bold border border-indigo-200" id="count-legal">0ä»¶</span>
    </div>
    <div class="flex justify-between items-center p-3 bg-indigo-50 border-b">
      <div class="flex gap-2">
        <button onclick="selectAllLegal()" class="text-xs px-3 py-1 bg-white border rounded hover:bg-gray-50">
          <i class="fas fa-check-square mr-1"></i>ã™ã¹ã¦é¸æŠ
        </button>
        <button onclick="deselectAllLegal()" class="text-xs px-3 py-1 bg-white border rounded hover:bg-gray-50">
          <i class="fas fa-square mr-1"></i>é¸æŠè§£é™¤
        </button>
      </div>
      <span class="text-xs font-bold text-indigo-600" id="legal-selected-count">0ä»¶é¸æŠä¸­</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-indigo-100 text-indigo-800">
          <tr>
            <th class="p-2 w-10">
              <input type="checkbox" class="legal-checkbox-all accent-indigo-600" onchange="toggleAllLegal(this)">
            </th>
            <th class="p-2">æ‹ ç‚¹</th>
            <th class="p-2">è¨­å‚™å</th>
            <th class="p-2">æœŸé™</th>
          </tr>
        </thead>
        <tbody id="table-legal" class="divide-y divide-indigo-100"><tr><td colspan="4" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
    <div class="p-3 bg-indigo-50 border-t flex gap-2 justify-end">
      <button onclick="bulkCreateProjectsLegal()" 
              class="px-4 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 disabled:bg-gray-400"
              id="btn-bulk-project-legal" disabled>
        <i class="fas fa-clipboard-list mr-1"></i>é¸æŠã—ãŸæ¡ˆä»¶ã‚’ä½œæˆ
      </button>
      <button onclick="bulkCreateEmailsLegal()" 
              class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400"
              id="btn-bulk-email-legal" disabled>
        <i class="fas fa-envelope mr-1"></i>é¸æŠã—ãŸæ¡ˆä»¶ã®ãƒ¡ãƒ¼ãƒ«ä½œæˆ
      </button>
    </div>
  </div>

  <!-- ä¸­æ®µ: é‡è¦è¨­å‚™ï¼ˆäº•æˆ¸ãƒãƒ³ãƒ—ãƒ¡ãƒ³ãƒ†ã‚’å«ã‚€ï¼‰ -->
  <div class="bg-white rounded-lg border-2 border-rose-200 shadow-md overflow-hidden">
    <div class="bg-rose-50 p-3 border-b border-rose-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-rose-800"><i class="fas fa-exclamation-triangle mr-2"></i>ã€é‡è¦ã€‘æœ¬ä½“æ›´æ–°ãƒ»å…¥æ›¿</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-rose-600 font-bold border border-rose-200" id="count-major">0ä»¶</span>
    </div>
    <div class="flex justify-between items-center p-3 bg-rose-50 border-b">
      <div class="flex gap-2">
        <button onclick="selectAllMajor()" class="text-xs px-3 py-1 bg-white border rounded hover:bg-gray-50">
          <i class="fas fa-check-square mr-1"></i>ã™ã¹ã¦é¸æŠ
        </button>
        <button onclick="deselectAllMajor()" class="text-xs px-3 py-1 bg-white border rounded hover:bg-gray-50">
          <i class="fas fa-square mr-1"></i>é¸æŠè§£é™¤
        </button>
      </div>
      <span class="text-xs font-bold text-rose-600" id="major-selected-count">0ä»¶é¸æŠä¸­</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-rose-100 text-rose-800">
          <tr>
            <th class="p-2 w-10">
              <input type="checkbox" class="major-checkbox-all accent-rose-600" onchange="toggleAllMajor(this)">
            </th>
            <th class="p-2">æ‹ ç‚¹</th>
            <th class="p-2">è¨­å‚™å</th>
            <th class="p-2">çŠ¶æ³</th>
          </tr>
        </thead>
        <tbody id="table-major" class="divide-y divide-rose-100"><tr><td colspan="4" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
    <div class="p-3 bg-rose-50 border-t flex gap-2 justify-end">
      <button onclick="bulkCreateProjectsMajor()" 
              class="px-4 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 disabled:bg-gray-400"
              id="btn-bulk-project-major" disabled>
        <i class="fas fa-clipboard-list mr-1"></i>é¸æŠã—ãŸæ¡ˆä»¶ã‚’ä½œæˆ
      </button>
      <button onclick="bulkCreateEmailsMajor()" 
              class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400"
              id="btn-bulk-email-major" disabled>
        <i class="fas fa-envelope mr-1"></i>é¸æŠã—ãŸæ¡ˆä»¶ã®ãƒ¡ãƒ¼ãƒ«ä½œæˆ
      </button>
    </div>
  </div>

  <!-- 4æœˆå®Ÿæ–½ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  <div class="bg-white rounded-lg border-2 border-blue-200 shadow-md overflow-hidden">
    <div class="bg-blue-50 p-3 border-b border-blue-200">
      <h3 class="text-lg font-bold text-blue-800"><i class="fas fa-calendar-alt mr-2"></i>ã€4æœˆå®Ÿæ–½ã€‘å®šæœŸéƒ¨å“äº¤æ›ãƒ»ä¸€æ‹¬ç™ºæ³¨</h3>
    </div>
    <div id="bulk-order-alerts" class="divide-y divide-blue-100">
      <div class="p-4 text-center text-gray-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
</div>

<script>
console.log('âœ… dashboard.html script loaded');

function dashboardInit(f=false) {
  console.log('ğŸš€ dashboardInit called, force:', f);
  
  // å®‰å…¨ã«g_cacheã‚’ç¢ºèª
  if (!window.g_cache) {
    console.log('â„¹ï¸ Initializing g_cache');
    window.g_cache = {};
  }

  if(!f && window.g_cache.dashboard) { 
    console.log('ğŸ“¦ Using cached dashboard data');
    renderDashboard(window.g_cache.dashboard); 
    loadAllBulkOrderAlerts();
    return; 
  }

  // showLoadingã®ã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ä¿è­·
  try {
    console.log('â³ Calling showLoading(true)...');
    if (typeof showLoading === 'function') {
      showLoading(true);
    } else {
      console.warn('âš ï¸ showLoading function not found');
    }
  } catch (e) {
    console.error('âš ï¸ showLoading execution failed (Ignoring):', e);
  }

  console.log('ğŸ“¡ Fetching new dashboard data...');
  google.script.run
    .withSuccessHandler(d => { 
      console.log('âœ… Dashboard data received', d);
      window.g_cache.dashboard=d; 
      
      try {
        renderDashboard(d); 
      } catch(e) {
        console.error('âŒ renderDashboard failed:', e);
      }
      
      try {
        console.log('â–¶ Triggering loadAllBulkOrderAlerts from SuccessHandler');
        loadAllBulkOrderAlerts();
      } catch(e) {
        console.error('âŒ loadAllBulkOrderAlerts call failed:', e);
      }
    })
    .withFailureHandler(e => {
      console.error('âŒ Dashboard data fetch failed', e);
      try { showLoading(false); } catch(err) {}
      alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
    })
    .getDashboardData();
}

function renderDashboard(data) {
  try { showLoading(false); } catch(e) {}
  
  const legalT = document.getElementById('table-legal'); 
  legalT.innerHTML = '';
  const majorT = document.getElementById('table-major'); 
  majorT.innerHTML = '';
  
  let lCount = 0, mjCount = 0;

  if (data && data.noticeList) {
    data.noticeList.forEach(i => {
      const category = i['ã‚«ãƒ†ã‚´ãƒª'];
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆåˆ¤å®šã‚’å€‹åˆ¥ã«å®šç¾©
      const hasBodyAlert = i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] !== 'æ­£å¸¸';
      const hasPartAAlert = i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] !== 'æ­£å¸¸';
      const hasPartBAlert = i['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] && i['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] !== 'æ­£å¸¸';
      
      const tr = document.createElement('tr');
      
      // æ³•å®šæ¤œæŸ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéƒ¨å“Aã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
      if (category === 'æ³•å®šæ¤œæŸ»' && hasPartAAlert) {
        lCount++;
        tr.className = "hover:bg-indigo-50";
        
        let statusLabel = i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
        let statusColor = (statusLabel === 'æœŸé™è¶…é') ? 'text-red-600' : 'text-indigo-600';
        let status = `<span class="font-bold ${statusColor}">${statusLabel}</span>`;
        
        tr.innerHTML = `
          <td class="p-2">
            <input type="checkbox" class="legal-checkbox accent-indigo-600"
                   data-loc="${i['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰']}"
                   data-eq="${i['è¨­å‚™ID']}"
                   data-name="${i['æ‹ ç‚¹å']}"
                   data-eqname="${i['è¨­å‚™å']}"
                   onchange="updateLegalSelection()">
          </td>
          <td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td>
          <td class="p-2">${i['è¨­å‚™å']}</td>
          <td class="p-2">${status}</td>
        `;
        legalT.appendChild(tr);
      }
      // æœ¬ä½“æ›´æ–°ãƒ»ç¾è¦³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæœ¬ä½“ã¾ãŸã¯éƒ¨å“Bã®ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
      else if ((category === 'æœ¬ä½“æ›´æ–°' || category === 'ç¾è¦³') && (hasBodyAlert || hasPartBAlert)) {
        mjCount++;
        tr.className = "hover:bg-rose-50";
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®å„ªå…ˆé †ä½ï¼šæœ¬ä½“ > éƒ¨å“B
        let statusLabel = '';
        let statusColor = '';
        
        if (hasBodyAlert) {
          statusLabel = i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
          statusColor = (statusLabel === 'æœŸé™è¶…é') ? 'text-rose-600' : 'text-amber-600';
        } else if (hasPartBAlert) {
          statusLabel = i['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
          statusColor = 'text-amber-600';
        }
        
        let status = `<span class="font-bold ${statusColor}">${statusLabel}</span>`;
        if(i['subsidyAlert']) {
          status += `<br><span class="text-xs text-white bg-red-500 px-1 rounded">${i['subsidyAlert']}</span>`;
        }
        
        const eqName = i['è¨­å‚™å'] || '';
        tr.innerHTML = `
          <td class="p-2">
            <input type="checkbox" class="major-checkbox accent-rose-600"
                   data-loc="${i['æ‹ ç‚¹ã‚³ãƒ¼ãƒ‰']}"
                   data-eq="${i['è¨­å‚™ID']}"
                   data-name="${i['æ‹ ç‚¹å']}"
                   data-eqname="${eqName}"
                   onchange="updateMajorSelection()">
          </td>
          <td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td>
          <td class="p-2">${i['è¨­å‚™å']}</td>
          <td class="p-2">${status}</td>
        `;
        majorT.appendChild(tr);
      }
      // éƒ¨ææ›´æ–°ãƒ»ä¸å®šæœŸã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«è¡¨ç¤ºã—ãªã„ï¼ˆè¨­å‚™ä¸€è¦§ã§ç®¡ç†ï¼‰
    });
  }

  document.getElementById('count-legal').innerText = lCount + 'ä»¶';
  document.getElementById('count-major').innerText = mjCount + 'ä»¶';

  if(lCount===0) legalT.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªæ³•å®šæ¤œæŸ»ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
  if(mjCount===0) majorT.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªé‡è¦æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
  
  updateLegalSelection();
  updateMajorSelection();
}

// ========================================
// æ³•å®šæ¤œæŸ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ“ä½œ
// ========================================

function updateLegalSelection() {
  const checked = document.querySelectorAll('.legal-checkbox:checked');
  document.getElementById('legal-selected-count').textContent = `${checked.length}ä»¶é¸æŠä¸­`;
  document.getElementById('btn-bulk-project-legal').disabled = (checked.length === 0);
  document.getElementById('btn-bulk-email-legal').disabled = (checked.length === 0);
}

function selectAllLegal() {
  document.querySelectorAll('.legal-checkbox').forEach(cb => cb.checked = true);
  updateLegalSelection();
}

function deselectAllLegal() {
  document.querySelectorAll('.legal-checkbox').forEach(cb => cb.checked = false);
  updateLegalSelection();
}

function toggleAllLegal(checkbox) {
  document.querySelectorAll('.legal-checkbox').forEach(cb => cb.checked = checkbox.checked);
  updateLegalSelection();
}

function bulkCreateProjectsLegal() {
  const checked = Array.from(document.querySelectorAll('.legal-checkbox:checked'));
  if (checked.length === 0) return;
  
  if (!confirm(`${checked.length}ä»¶ã®æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹?`)) return;
  
  showLoading(true);
  let completed = 0;
  
  checked.forEach((cb) => {
    const locCode = cb.dataset.loc;
    const eqId = cb.dataset.eq;
    const locName = cb.dataset.name;
    const eqName = cb.dataset.eqname;
    
    google.script.run
      .withSuccessHandler(() => {
        completed++;
        if (completed === checked.length) {
          showLoading(false);
          alert(`${completed}ä»¶ã®æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ`);
          deselectAllLegal();
          dashboardInit(true);
        }
      })
      .withFailureHandler((error) => {
        showLoading(false);
        alert(`ã‚¨ãƒ©ãƒ¼: ${error}`);
      })
      .createIndividualProject(locCode, eqId, locName, eqName, 'æ³•å®šæ¤œæŸ»');
  });
}

function bulkCreateEmailsLegal() {
  const checked = Array.from(document.querySelectorAll('.legal-checkbox:checked'));
  if (checked.length === 0) return;
  
  if (!confirm(`${checked.length}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹?`)) return;
  
  showLoading(true);
  let completed = 0;
  
  checked.forEach((cb) => {
    const locCode = cb.dataset.loc;
    const eqId = cb.dataset.eq;
    const locName = cb.dataset.name;
    const eqName = cb.dataset.eqname;
    
    google.script.run
      .withSuccessHandler(() => {
        completed++;
        if (completed === checked.length) {
          showLoading(false);
          alert(`${completed}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã—ãŸ`);
          deselectAllLegal();
        }
      })
      .withFailureHandler((error) => {
        showLoading(false);
        alert(`ã‚¨ãƒ©ãƒ¼: ${error}`);
      })
      .createIndividualGmailDraft(locCode, eqId, locName, eqName, 'æ³•å®šæ¤œæŸ»');
  });
}

// ========================================
// é‡è¦è¨­å‚™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ“ä½œ
// ========================================

function updateMajorSelection() {
  const checked = document.querySelectorAll('.major-checkbox:checked');
  document.getElementById('major-selected-count').textContent = `${checked.length}ä»¶é¸æŠä¸­`;
  document.getElementById('btn-bulk-project-major').disabled = (checked.length === 0);
  document.getElementById('btn-bulk-email-major').disabled = (checked.length === 0);
}

function selectAllMajor() {
  document.querySelectorAll('.major-checkbox').forEach(cb => cb.checked = true);
  updateMajorSelection();
}

function deselectAllMajor() {
  document.querySelectorAll('.major-checkbox').forEach(cb => cb.checked = false);
  updateMajorSelection();
}

function toggleAllMajor(checkbox) {
  document.querySelectorAll('.major-checkbox').forEach(cb => cb.checked = checkbox.checked);
  updateMajorSelection();
}

function bulkCreateProjectsMajor() {
  const checked = Array.from(document.querySelectorAll('.major-checkbox:checked'));
  if (checked.length === 0) return;
  
  if (!confirm(`${checked.length}ä»¶ã®æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹?`)) return;
  
  showLoading(true);
  let completed = 0;
  
  checked.forEach((cb) => {
    const locCode = cb.dataset.loc;
    const eqId = cb.dataset.eq;
    const locName = cb.dataset.name;
    const eqName = cb.dataset.eqname;
    
    google.script.run
      .withSuccessHandler(() => {
        completed++;
        if (completed === checked.length) {
          showLoading(false);
          alert(`${completed}ä»¶ã®æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ`);
          deselectAllMajor();
          dashboardInit(true);
        }
      })
      .withFailureHandler((error) => {
        showLoading(false);
        alert(`ã‚¨ãƒ©ãƒ¼: ${error}`);
      })
      .createIndividualProject(locCode, eqId, locName, eqName, 'æœ¬ä½“æ›´æ–°');
  });
}

function bulkCreateEmailsMajor() {
  const checked = Array.from(document.querySelectorAll('.major-checkbox:checked'));
  if (checked.length === 0) return;
  
  if (!confirm(`${checked.length}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹?`)) return;
  
  showLoading(true);
  let completed = 0;
  
  checked.forEach((cb) => {
    const locCode = cb.dataset.loc;
    const eqId = cb.dataset.eq;
    const locName = cb.dataset.name;
    const eqName = cb.dataset.eqname;
    
    google.script.run
      .withSuccessHandler(() => {
        completed++;
        if (completed === checked.length) {
          showLoading(false);
          alert(`${completed}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã—ãŸ`);
          deselectAllMajor();
        }
      })
      .withFailureHandler((error) => {
        showLoading(false);
        alert(`ã‚¨ãƒ©ãƒ¼: ${error}`);
      })
      .createIndividualGmailDraft(locCode, eqId, locName, eqName, 'æœ¬ä½“æ›´æ–°');
  });
}

// å…¨ã¦ã®ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒã‚ºãƒ«ã‚«ãƒãƒ¼ + ãã®ä»–4ç¨®é¡ï¼‰
function loadAllBulkOrderAlerts() {
  console.log('ğŸ”„ loadAllBulkOrderAlerts started');
  const container = document.getElementById('bulk-order-alerts');
  if (!container) {
    console.error('âŒ Container #bulk-order-alerts not found');
    return;
  }
  
  container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã‚’ç¢ºèªä¸­...</div>';
  
  // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
  console.log('ğŸ“¡ Calling getNozzleCoverInfo...');
  google.script.run
    .withSuccessHandler(function(nozzleInfo) {
      console.log('âœ… getNozzleCoverInfo success:', nozzleInfo);
      
      // ãã®ä»–ã®ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã‚’å–å¾—
      console.log('ğŸ“¡ Calling getAllBulkOrderInfo...');
      google.script.run
        .withSuccessHandler(function(allInfo) {
          console.log('âœ… getAllBulkOrderInfo success:', allInfo);
          
          window.bulkOrderDataMap = {};
          window.nozzleCoverData = nozzleInfo;
          
          container.innerHTML = '';
          
          let hasAnyAlert = false;
          
          // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ã‚’è¡¨ç¤º
          if (nozzleInfo && nozzleInfo.hasAlert) {
            hasAnyAlert = true;
            // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ bulkOrderDataMap ã«è¿½åŠ ï¼ˆcreateBulkOrderProjectFor ã§ä½¿ç”¨ï¼‰
            window.bulkOrderDataMap = window.bulkOrderDataMap || {};
            window.bulkOrderDataMap['PARTS-PUMP-1Y'] = nozzleInfo;
            try {
              const div = createBulkAlertDiv(nozzleInfo, 'nozzle');
              container.appendChild(div);
            } catch(e) { console.error('Error creating nozzle div', e); }
          }
          
          // ãã®ä»–ã®4ç¨®é¡ã‚’è¡¨ç¤º
          if (allInfo && Array.isArray(allInfo)) {
            allInfo.forEach(function(info) {
              const equipmentId = info.config.id;
              window.bulkOrderDataMap[equipmentId] = info;
              
              if (info.hasAlert) {
                hasAnyAlert = true;
                try {
                  const div = createBulkAlertDiv(info, 'standard');
                  container.appendChild(div);
                } catch(e) { console.error('Error creating standard div', e); }
              }
            });
          }
          
          if (!hasAnyAlert) {
            container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">4æœˆå®Ÿæ–½äºˆå®šã®ä¸€æ‹¬ç™ºæ³¨ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          }
        })
        .withFailureHandler(function(error) {
          console.error('âŒ getAllBulkOrderInfo failed:', error);
          container.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        })
        .getAllBulkOrderInfo();
    })
    .withFailureHandler(function(error) {
      console.error('âŒ getNozzleCoverInfo failed:', error);
      container.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    })
    .getNozzleCoverInfo();
}

// ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã‚’ä½œæˆ
function createBulkAlertDiv(info, type) {
  const div = document.createElement('div');
  div.className = 'p-4 border-b border-blue-100 hover:bg-blue-50 transition';
  
  let storeList = '';
  if (info.targetStores && info.targetStores.length > 0) {
    if (info.targetStores.length <= 8) {
      storeList = info.targetStores.map(function(s) { return s.name; }).join(', ');
    } else {
      storeList = info.targetStores.slice(0, 5).map(function(s) { return s.name; }).join(', ') + ' ä»–' + (info.targetStores.length - 5) + 'åº—èˆ—';
    }
  }
  
  const equipmentId = info.config.id;
  
  // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ç”¨ã¨æ¨™æº–ç”¨ã§çµ±ä¸€
  const buttons = `
    <button onclick="showBulkEmailDraftWithGmail('${equipmentId}')" 
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope mr-1"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã
    </button>
    <button onclick="createBulkOrderProjectFor('${equipmentId}')" 
            class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-clipboard-list mr-1"></i>æ¡ˆä»¶ä½œæˆ
    </button>
  `;
  
  div.innerHTML = `
    <div class="flex items-start justify-between mb-2">
      <div class="flex-1">
        <div class="text-base font-bold text-blue-900 mb-1">
          ${info.config.name} (${info.targetYear}å¹´4æœˆå®Ÿæ–½äºˆå®š) - ${info.targetCount}åº—èˆ—
        </div>
        <div class="text-sm text-blue-700 ml-7 mt-1">
          å¯¾è±¡: ${storeList}
        </div>
      </div>
    </div>
    <div class="flex gap-2 ml-7 mt-2">
      ${buttons}
    </div>
  `;
  
  return div;
}


// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›Gmailä¸‹æ›¸ãä½œæˆ
function createNozzleCoverGmailDraft() {
  if (!confirm('Gmailã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert('âœ… ' + result.message + '\n\nä»¶å: ' + result.subject + '\nå®›å…ˆ: ' + result.recipient + '\n\nGmailã®ä¸‹æ›¸ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ Gmailä¸‹æ›¸ãä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createNozzleCoverGmailDraft();
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›æ¡ˆä»¶ä½œæˆ
function createNozzleCoverProject() {
  if (!window.nozzleCoverData) {
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™');
    return;
  }
  
  const info = window.nozzleCoverData;
  
  if (!confirm(`ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ã®ä¸€æ‹¬æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹?\n\nå¯¾è±¡: ${info.targetCount}åº—èˆ—ï¼ˆå…¨åº—ï¼‰\nå®Ÿæ–½äºˆå®š: ${info.targetYear}å¹´4æœˆ`)) {
    return;
  }
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}\nè¨­å‚™: ${result.equipmentName}\nå¯¾è±¡åº—èˆ—: ${result.targetCount}åº—èˆ—`);
      navigate('projects');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createNozzleCoverProject();
}

// Gmailä¸‹æ›¸ãä½œæˆ
function createBulkOrderGmailDraftFor(equipmentId) {
  if (!confirm('Gmailã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert('âœ… ' + result.message + '\n\nä»¶å: ' + result.subject + '\nå®›å…ˆ: ' + result.recipient + '\n\nGmailã®ä¸‹æ›¸ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ Gmailä¸‹æ›¸ãä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createBulkOrderGmailDraft(equipmentId);
}


// æ¡ˆä»¶ã‚’ä½œæˆ
function createBulkOrderProjectFor(equipmentId) {
  // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
  if (equipmentId === 'PARTS-PUMP-1Y') {
    if (!window.nozzleCoverData) {
      alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
      return;
    }
    
    const info = window.nozzleCoverData;
    if (!confirm(`ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ã®ä¸€æ‹¬æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹?\n\nå¯¾è±¡: ${info.targetCount}åº—èˆ—ï¼ˆå…¨åº—ï¼‰\nå®Ÿæ–½äºˆå®š: ${info.targetYear}å¹´4æœˆ`)) {
      return;
    }
    
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(result) {
        showLoading(false);
        alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}\nè¨­å‚™: ${result.equipmentName}\nå¯¾è±¡åº—èˆ—: ${result.targetCount}åº—èˆ—`);
        navigate('projects');
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
      })
      .createNozzleCoverProject();
    return;
  }
  
  if (!window.bulkOrderDataMap || !window.bulkOrderDataMap[equipmentId]) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  
  const info = window.bulkOrderDataMap[equipmentId];
  const targetCount = info.targetCount;
  const targetYear = info.targetYear || new Date().getFullYear();
  
  if (!confirm(`${targetYear}å¹´åº¦ã®${info.config.name}ä¸€æ‹¬ç™ºæ³¨æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡åº—èˆ—: ${targetCount}åº—èˆ—\nå®Ÿæ–½äºˆå®š: ${targetYear}å¹´4æœˆ\nç™ºæ³¨å…ˆ: ${info.config.vendor}`)) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}\nè¨­å‚™: ${result.equipmentName}\nå¯¾è±¡åº—èˆ—: ${result.targetCount}åº—èˆ—`);
      navigate('projects');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createBulkOrderProject(equipmentId);
}

// ã‚¨ã‚¢ã‚³ãƒ³æ›´æ–°ï¼šé›»è©±ä¾é ¼ï¼‹æ¡ˆä»¶ä½œæˆ
function createPhoneCallProject(locCode, eqId, locName, eqName) {
  const memo = prompt(
    `${locName} - ${eqName}\n\né›»è©±ä¾é ¼ã®å†…å®¹ã‚„æ¥­è€…åã‚’ãƒ¡ãƒ¢ã—ã¦ãã ã•ã„ï¼š`,
    'ã‚±ãƒ¼ã‚ºãƒ‡ãƒ³ã‚­ã«é›»è©±ä¾é ¼'
  );
  
  if (!memo) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler((result) => {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\né›»è©±ã§ä¾é ¼å¾Œã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¦ãã ã•ã„`);
      navigate('projects'); // æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ–ã¸ç§»å‹•
    })
    .withFailureHandler((error) => {
      showLoading(false);
      alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error);
    })
    .createPhoneCallProject(locCode, eqId, eqName, memo);
}

// å€‹åˆ¥æ¡ˆä»¶ã®ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ããƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showIndividualEmailDraft(locCode, eqId, locName, eqName, workType) {
  const subject = 'ã€è¦‹ç©ä¾é ¼ã€‘è¦‹ç©ã‚Šä¾é ¼ã®ä»¶';
  let body = 'ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n\n';
  body += 'ä»¥ä¸‹ã®è¨­å‚™ã«ã¤ãã¾ã—ã¦ã€è¦‹ç©ã‚‚ã‚Šã‚’ãŠé¡˜ã„ã—ãŸãå­˜ã˜ã¾ã™ã€‚\n\n';
  body += `â–  ã‚»ãƒ«ãƒ•ã‚£ãƒƒã‚¯ã‚¹${locName}\n`;
  body += `ãƒ»è¨­å‚™: ${eqName}\n`;
  body += `ãƒ»ä½œæ¥­å†…å®¹: ${workType}\n\n`;
  body += '--------------------------------------------------\n';
  body += 'æ—¥å•†æœ‰ç”°æ ªå¼ä¼šç¤¾\nè¥¿æ‘\n';
  body += '--------------------------------------------------';
  
  showEmailDraftModal(subject, body, locCode, eqId, locName, eqName, workType);
}

// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ããƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆå…±é€šï¼‰
function showEmailDraftModal(subject, body, locCode, eqId, locName, eqName, workType) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
  
  const content = document.createElement('div');
  content.className = 'bg-white rounded-lg shadow-2xl';
  content.style.cssText = 'max-width: 700px; max-height: 85vh; width: 90%;';
  
  content.innerHTML = `
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-lg">
      <h2 class="text-xl font-bold"><i class="fas fa-envelope mr-2"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã - ${locName}</h2>
    </div>
    <div class="p-6">
      <textarea id="individual-email-draft" readonly 
                class="w-full h-96 font-mono text-sm p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" 
                style="resize: none;">${body}</textarea>
      <div class="mt-4 flex gap-3 justify-end">
        <button onclick="copyIndividualEmailDraft()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
        </button>
        <button onclick="createIndividualGmailDraft('${locCode}', '${eqId}', '${locName}', '${eqName}', '${workType}')" 
                class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-envelope-open mr-2"></i>Gmailä¸‹æ›¸ãä½œæˆ
        </button>
        <button onclick="closeIndividualEmailModal()" 
                class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-times mr-2"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  window.currentIndividualModal = modal;
  
  modal.onclick = function(e) {
    if (e.target === modal) closeIndividualEmailModal();
  };
}

function copyIndividualEmailDraft() {
  const textarea = document.getElementById('individual-email-draft');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('âœ… ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch (err) {
    alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  }
}

function closeIndividualEmailModal() {
  if (window.currentIndividualModal) {
    document.body.removeChild(window.currentIndividualModal);
    window.currentIndividualModal = null;
  }
}

function createIndividualGmailDraft(locCode, eqId, locName, eqName, workType) {
  if (!confirm('Gmailã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  closeIndividualEmailModal();
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert('âœ… Gmailä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã—ãŸ\n\nGmailã®ä¸‹æ›¸ããƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ Gmailä¸‹æ›¸ãä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createIndividualGmailDraft(locCode, eqId, locName, eqName, workType);
}

function createIndividualProject(locCode, eqId, locName, eqName, workType) {
  if (!confirm(`æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nã‚»ãƒ«ãƒ•ã‚£ãƒƒã‚¯ã‚¹${locName}\n${eqName}\nä½œæ¥­: ${workType}`)) return;
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}`);
      navigate('projects');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createIndividualProject(locCode, eqId, locName, eqName, workType);
}

// ä¸€æ‹¬ç™ºæ³¨ã®ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ããƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆGmailä¸‹æ›¸ãä½œæˆãƒœã‚¿ãƒ³ä»˜ãï¼‰
function showBulkEmailDraftWithGmail(equipmentId) {
  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  let info = null;
  
  if (equipmentId === 'PARTS-PUMP-1Y') {
    info = window.nozzleCoverData;
  } else if (window.bulkOrderDataMap) {
    info = window.bulkOrderDataMap[equipmentId];
  }
  
  if (!info) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
  
  const content = document.createElement('div');
  content.className = 'bg-white rounded-lg shadow-2xl';
  content.style.cssText = 'max-width: 700px; max-height: 85vh; width: 90%;';
  
  content.innerHTML = `
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-lg">
      <h2 class="text-xl font-bold"><i class="fas fa-envelope mr-2"></i>${info.config.emoji || ''} ${info.config.name} - ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã</h2>
    </div>
    <div class="p-6">
      <textarea id="bulk-email-draft-text" readonly 
                class="w-full h-96 font-mono text-sm p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" 
                style="resize: none;">${info.emailDraft}</textarea>
      <div class="mt-4 flex gap-3 justify-end">
        <button onclick="copyBulkEmailDraftText()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
        </button>
        <button onclick="createBulkOrderGmailDraftFor('${equipmentId}')" 
                class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-envelope-open mr-2"></i>Gmailä¸‹æ›¸ãä½œæˆ
        </button>
        <button onclick="closeBulkEmailDraftModal()" 
                class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-times mr-2"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  window.currentBulkEmailModal = modal;
  
  modal.onclick = function(e) {
    if (e.target === modal) closeBulkEmailDraftModal();
  };
}

// ä¸€æ‹¬ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚³ãƒ”ãƒ¼
function copyBulkEmailDraftText() {
  const textarea = document.getElementById('bulk-email-draft-text');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('âœ… ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch (err) {
    alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  }
}

// ä¸€æ‹¬ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeBulkEmailDraftModal() {
  if (window.currentBulkEmailModal) {
    document.body.removeChild(window.currentBulkEmailModal);
    window.currentBulkEmailModal = null;
  }
}

</script>