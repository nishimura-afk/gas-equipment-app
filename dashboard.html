<!-- Dashboard View -->
<div class="space-y-8">
  <div class="flex justify-between items-center border-b pb-4">
    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-pie mr-2"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <button onclick="dashboardInit(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition shadow">
      <i class="fas fa-sync-alt mr-1"></i> æ›´æ–°
    </button>
  </div>

  <!-- ä¸Šæ®µ: æ³•å®šæ¤œæŸ» -->
  <div class="bg-white rounded-lg border-2 border-indigo-200 shadow-md overflow-hidden">
    <div class="bg-indigo-50 p-3 border-b border-indigo-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-indigo-800"><i class="fas fa-balance-scale mr-2"></i>ã€æœ€å„ªå…ˆã€‘æ³•å®šæ¤œæŸ»</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-indigo-600 font-bold border border-indigo-200" id="count-legal">0ä»¶</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-indigo-100 text-indigo-800">
          <tr><th class="p-2">æ‹ ç‚¹</th><th class="p-2">è¨­å‚™å</th><th class="p-2">æœŸé™</th></tr>
        </thead>
        <tbody id="table-legal" class="divide-y divide-indigo-100"><tr><td colspan="3" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ä¸­æ®µ: é‡è¦è¨­å‚™ -->
  <div class="bg-white rounded-lg border-2 border-rose-200 shadow-md overflow-hidden">
    <div class="bg-rose-50 p-3 border-b border-rose-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-rose-800"><i class="fas fa-exclamation-triangle mr-2"></i>ã€é‡è¦ã€‘æœ¬ä½“æ›´æ–°ãƒ»å…¥æ›¿</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-rose-600 font-bold border border-rose-200" id="count-major">0ä»¶</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-rose-100 text-rose-800">
          <tr><th class="p-2">æ‹ ç‚¹</th><th class="p-2">è¨­å‚™å</th><th class="p-2">çŠ¶æ³</th></tr>
        </thead>
        <tbody id="table-major" class="divide-y divide-rose-100"><tr><td colspan="3" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ä¸‹æ®µ: å®šä¾‹æ¶ˆè€—å“ -->
  <div class="bg-white rounded-lg border-2 border-amber-200 shadow-md overflow-hidden">
    <div class="bg-amber-50 p-3 border-b border-amber-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-amber-800"><i class="fas fa-tools mr-2"></i>ã€å®šä¾‹ã€‘å®šæœŸéƒ¨å“äº¤æ›ãƒ»æ¶ˆè€—å“</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-amber-600 font-bold border border-amber-200" id="count-minor">0ä»¶</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-amber-100 text-amber-800">
          <tr><th class="p-2">æ‹ ç‚¹</th><th class="p-2">å†…å®¹</th><th class="p-2">æ™‚æœŸ</th></tr>
        </thead>
        <tbody id="table-minor" class="divide-y divide-amber-100"><tr><td colspan="3" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- 4æœˆå®Ÿæ–½ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  <div class="bg-white rounded-lg border-2 border-blue-200 shadow-md overflow-hidden">
    <div class="bg-blue-50 p-3 border-b border-blue-200">
      <h3 class="text-lg font-bold text-blue-800"><i class="fas fa-calendar-alt mr-2"></i>ã€4æœˆå®Ÿæ–½ã€‘å®šæœŸéƒ¨å“äº¤æ›ãƒ»ä¸€æ‹¬ç™ºæ³¨</h3>
    </div>
    <div id="bulk-order-alerts" class="divide-y divide-blue-100">
      <div class="p-4 text-center text-gray-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
</div>

<script>
console.log('âœ… dashboard.html script loaded - v3 (Protection Mode)');

function dashboardInit(f=false) {
  console.log('ğŸš€ dashboardInit called, force:', f);
  
  // å®‰å…¨ã«g_cacheã‚’ç¢ºèª
  if (!window.g_cache) {
    console.log('â„¹ï¸ Initializing g_cache');
    window.g_cache = {};
  }

  if(!f && window.g_cache.dashboard) { 
    console.log('ğŸ“¦ Using cached dashboard data');
    renderDashboard(window.g_cache.dashboard); 
    loadAllBulkOrderAlerts();
    return; 
  }

  // showLoadingã®ã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ä¿è­·
  try {
    console.log('â³ Calling showLoading(true)...');
    if (typeof showLoading === 'function') {
      showLoading(true);
    } else {
      console.warn('âš ï¸ showLoading function not found');
    }
  } catch (e) {
    console.error('âš ï¸ showLoading execution failed (Ignoring):', e);
  }

  console.log('ğŸ“¡ Fetching new dashboard data...');
  google.script.run
    .withSuccessHandler(d => { 
      console.log('âœ… Dashboard data received', d);
      window.g_cache.dashboard=d; 
      
      try {
        renderDashboard(d); 
      } catch(e) {
        console.error('âŒ renderDashboard failed:', e);
      }
      
      try {
        console.log('â–¶ Triggering loadAllBulkOrderAlerts from SuccessHandler');
        loadAllBulkOrderAlerts();
      } catch(e) {
        console.error('âŒ loadAllBulkOrderAlerts call failed:', e);
      }
    })
    .withFailureHandler(e => {
      console.error('âŒ Dashboard data fetch failed', e);
      try { showLoading(false); } catch(err) {}
      alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
    })
    .getDashboardData();
}

function renderDashboard(data) {
  try { showLoading(false); } catch(e) {}
  
  const legalT = document.getElementById('table-legal'); legalT.innerHTML = '';
  const majorT = document.getElementById('table-major'); majorT.innerHTML = '';
  const minorT = document.getElementById('table-minor'); minorT.innerHTML = '';
  
  let lCount = 0, mjCount = 0, mnCount = 0;

  if (data && data.noticeList) {
    data.noticeList.forEach(i => {
      const category = i['ã‚«ãƒ†ã‚´ãƒª'];
      const tr = document.createElement('tr');
      
      if (category === 'æ³•å®šæ¤œæŸ»') {
        lCount++;
        tr.className = "hover:bg-indigo-50";
        let statusLabel = i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
        let statusColor = (statusLabel === 'æœŸé™è¶…é') ? 'text-red-600' : 'text-indigo-600';
        let status = `<span class="font-bold ${statusColor}">${statusLabel}</span>`;
        tr.innerHTML = `<td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td><td class="p-2">${i['è¨­å‚™å']}</td><td class="p-2">${status}</td>`;
        legalT.appendChild(tr);
      }
      else if (category === 'æœ¬ä½“æ›´æ–°' || category === 'ç¾è¦³') {
        mjCount++;
        tr.className = "hover:bg-rose-50";
        let status = `<span class="font-bold ${i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='æœŸé™è¶…é'?'text-rose-600':'text-amber-600'}">${i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}</span>`;
        if(i['subsidyAlert']) status += `<br><span class="text-xs text-white bg-red-500 px-1 rounded">${i['subsidyAlert']}</span>`;
        tr.innerHTML = `<td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td><td class="p-2">${i['è¨­å‚™å']}</td><td class="p-2">${status}</td>`;
        majorT.appendChild(tr);
      } 
      else {
        mnCount++;
        tr.className = "hover:bg-amber-50";
        let content = [];
        if(i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']!=='æ­£å¸¸') content.push(`æ¶ˆè€—å“: ${i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}`);
        if(i['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']!=='æ­£å¸¸' && i['éƒ¨å“Bå¯¾è±¡']) content.push(`æ•´å‚™: ${i['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}`);
        if(i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']!=='æ­£å¸¸') content.push(`æœ¬ä½“: ${i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}`);
        tr.innerHTML = `<td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td><td class="p-2">${i['è¨­å‚™å']}</td><td class="p-2 text-xs font-bold text-slate-600">${content.join('<br>')}</td>`;
        minorT.appendChild(tr);
      }
    });
  }

  document.getElementById('count-legal').innerText = lCount + 'ä»¶';
  document.getElementById('count-major').innerText = mjCount + 'ä»¶';
  document.getElementById('count-minor').innerText = mnCount + 'ä»¶';

  if(lCount===0) legalT.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªæ³•å®šæ¤œæŸ»ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
  if(mjCount===0) majorT.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªé‡è¦æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
  if(mnCount===0) minorT.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªæ¶ˆè€—å“äº¤æ›ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
}

// å…¨ã¦ã®ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒã‚ºãƒ«ã‚«ãƒãƒ¼ + ãã®ä»–4ç¨®é¡ï¼‰
function loadAllBulkOrderAlerts() {
  console.log('ğŸ”„ loadAllBulkOrderAlerts started');
  const container = document.getElementById('bulk-order-alerts');
  if (!container) {
    console.error('âŒ Container #bulk-order-alerts not found');
    return;
  }
  
  container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã‚’ç¢ºèªä¸­...</div>';
  
  // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆé–¢æ•°åã‚’å¤‰æ›´ï¼‰
  console.log('ğŸ“¡ Calling getNozzleCoverInfoV2...');
  google.script.run
    .withSuccessHandler(function(nozzleInfo) {
      console.log('âœ… getNozzleCoverInfoV2 success:', nozzleInfo);
      
      // ãã®ä»–ã®ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã‚’å–å¾—ï¼ˆé–¢æ•°åã‚’å¤‰æ›´ï¼‰
      console.log('ğŸ“¡ Calling getAllBulkOrderInfoV2...');
      google.script.run
        .withSuccessHandler(function(allInfo) {
          console.log('âœ… getAllBulkOrderInfoV2 success:', allInfo);
          
          window.bulkOrderDataMap = {};
          window.nozzleCoverData = nozzleInfo;
          
          container.innerHTML = '';
          
          let hasAnyAlert = false;
          
          // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ã‚’è¡¨ç¤º
          if (nozzleInfo && nozzleInfo.hasAlert && nozzleInfo.targetCount > 0) {
            hasAnyAlert = true;
            try {
              const div = createBulkAlertDiv(nozzleInfo, 'nozzle');
              container.appendChild(div);
            } catch(e) { console.error('Error creating nozzle div', e); }
          }
          
          // ãã®ä»–ã®4ç¨®é¡ã‚’è¡¨ç¤º
          if (allInfo && Array.isArray(allInfo)) {
            allInfo.forEach(function(info) {
              const equipmentId = info.config.id;
              window.bulkOrderDataMap[equipmentId] = info;
              
              if (info.hasAlert) {
                hasAnyAlert = true;
                try {
                  const div = createBulkAlertDiv(info, 'standard');
                  container.appendChild(div);
                } catch(e) { console.error('Error creating standard div', e); }
              }
            });
          }
          
          if (!hasAnyAlert) {
            container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">4æœˆå®Ÿæ–½äºˆå®šã®ä¸€æ‹¬ç™ºæ³¨ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          }
        })
        .withFailureHandler(function(error) {
          console.error('âŒ getAllBulkOrderInfoV2 failed:', error);
          container.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        })
        .getAllBulkOrderInfoV2();
    })
    .withFailureHandler(function(error) {
      console.error('âŒ getNozzleCoverInfoV2 failed:', error);
      container.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    })
    .getNozzleCoverInfoV2();
}

// ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã‚’ä½œæˆ
function createBulkAlertDiv(info, type) {
  const div = document.createElement('div');
  div.className = 'p-4 border-b border-blue-100 hover:bg-blue-50 transition';
  
  let storeList = '';
  if (info.targetStores && info.targetStores.length > 0) {
    if (info.targetStores.length <= 8) {
      storeList = info.targetStores.map(function(s) { return s.name; }).join(', ');
    } else {
      storeList = info.targetStores.slice(0, 5).map(function(s) { return s.name; }).join(', ') + ' ä»–' + (info.targetStores.length - 5) + 'åº—èˆ—';
    }
  }
  
  const equipmentId = info.config.id;
  const isNozzle = (type === 'nozzle');
  
  const buttons = isNozzle ? `
    <button onclick="showNozzleCoverEmailDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope mr-1"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã
    </button>
    <button onclick="createNozzleCoverGmailDraft()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope-open mr-1"></i>Gmailä¸‹æ›¸ãä½œæˆ
    </button>
    <button onclick="createNozzleCoverProject()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-clipboard-list mr-1"></i>æ¡ˆä»¶ä½œæˆ
    </button>
  ` : `
    <button onclick="showBulkEmailDraft('${equipmentId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope mr-1"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã
    </button>
    <button onclick="createBulkOrderGmailDraftFor('${equipmentId}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope-open mr-1"></i>Gmailä¸‹æ›¸ãä½œæˆ
    </button>
    <button onclick="createBulkOrderProjectFor('${equipmentId}')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-clipboard-list mr-1"></i>æ¡ˆä»¶ä½œæˆ
    </button>
  `;
  
  div.innerHTML = `
    <div class="flex items-start justify-between mb-2">
      <div class="flex-1">
        <div class="text-base font-bold text-blue-900 mb-1">
          <span class="text-xl mr-2">${info.config.emoji}</span>
          ${info.config.name} (${info.targetYear}å¹´4æœˆå®Ÿæ–½äºˆå®š) - ${info.targetCount}åº—èˆ—
        </div>
        <div class="text-sm text-blue-700 ml-7 mt-1">
          å¯¾è±¡: ${storeList}
        </div>
      </div>
    </div>
    <div class="flex gap-2 ml-7 mt-2">
      ${buttons}
    </div>
  `;
  
  return div;
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãè¡¨ç¤º
function showNozzleCoverEmailDraft() {
  if (!window.nozzleCoverData) {
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™');
    return;
  }
  
  const info = window.nozzleCoverData;
  const modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
  
  const content = document.createElement('div');
  content.className = 'bg-white rounded-lg shadow-2xl';
  content.style.cssText = 'max-width: 700px; max-height: 85vh; width: 90%;';
  
  content.innerHTML = `
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-lg">
      <h2 class="text-xl font-bold"><i class="fas fa-envelope mr-2"></i>ğŸ“¦ ${info.config.name} - ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã</h2>
    </div>
    <div class="p-6">
      <textarea id="nozzle-email-draft-text" readonly class="w-full h-96 font-mono text-sm p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" style="resize: none;">${info.emailDraft}</textarea>
      <div class="mt-4 flex gap-3 justify-end">
        <button onclick="copyNozzleEmailDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
        </button>
        <button onclick="closeNozzleModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-times mr-2"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  window.currentNozzleModal = modal;
  
  modal.onclick = function(e) {
    if (e.target === modal) closeNozzleModal();
  };
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚³ãƒ”ãƒ¼
function copyNozzleEmailDraft() {
  const textarea = document.getElementById('nozzle-email-draft-text');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('âœ… ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch (err) {
    alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  }
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeNozzleModal() {
  if (window.currentNozzleModal) {
    document.body.removeChild(window.currentNozzleModal);
    window.currentNozzleModal = null;
  }
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›Gmailä¸‹æ›¸ãä½œæˆ
function createNozzleCoverGmailDraft() {
  if (!confirm('Gmailã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert('âœ… ' + result.message + '\n\nä»¶å: ' + result.subject + '\nå®›å…ˆ: ' + result.recipient + '\n\nGmailã®ä¸‹æ›¸ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ Gmailä¸‹æ›¸ãä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createNozzleCoverGmailDraft();
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›æ¡ˆä»¶ä½œæˆ
function createNozzleCoverProject() {
  if (!window.nozzleCoverData) {
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™');
    return;
  }
  
  const info = window.nozzleCoverData;
  
  if (!confirm(`ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ã®ä¸€æ‹¬æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹?\n\nå¯¾è±¡: ${info.targetCount}åº—èˆ—ï¼ˆå…¨åº—ï¼‰\nå®Ÿæ–½äºˆå®š: ${info.targetYear}å¹´4æœˆ`)) {
    return;
  }
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}\nè¨­å‚™: ${result.equipmentName}\nå¯¾è±¡åº—èˆ—: ${result.targetCount}åº—èˆ—`);
      navigate('projects');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createNozzleCoverProject();
}

// Gmailä¸‹æ›¸ãä½œæˆ
function createBulkOrderGmailDraftFor(equipmentId) {
  if (!confirm('Gmailã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert('âœ… ' + result.message + '\n\nä»¶å: ' + result.subject + '\nå®›å…ˆ: ' + result.recipient + '\n\nGmailã®ä¸‹æ›¸ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ Gmailä¸‹æ›¸ãä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createBulkOrderGmailDraft(equipmentId);
}

// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’è¡¨ç¤º
function showBulkEmailDraft(equipmentId) {
  const info = window.bulkOrderData ? window.bulkOrderData.find(d => d.config.id === equipmentId) : (window.bulkOrderDataMap ? window.bulkOrderDataMap[equipmentId] : null);
  if (!info) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  showBulkOrderDraft(equipmentId);
}

function showBulkOrderDraft(equipmentId) {
  if (!window.bulkOrderDataMap || !window.bulkOrderDataMap[equipmentId]) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  
  const info = window.bulkOrderDataMap[equipmentId];
  const draft = info.emailDraft;
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
  
  const content = document.createElement('div');
  content.className = 'bg-white rounded-lg shadow-2xl';
  content.style.cssText = 'max-width: 700px; max-height: 85vh; width: 90%;';
  
  content.innerHTML = `
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-lg">
      <h2 class="text-xl font-bold"><i class="fas fa-envelope mr-2"></i>${info.config.emoji} ${info.config.name} - ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã</h2>
    </div>
    <div class="p-6">
      <textarea id="email-draft-text" readonly class="w-full h-96 font-mono text-sm p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" style="resize: none;">${draft}</textarea>
      <div class="mt-4 flex gap-3 justify-end">
        <button onclick="copyBulkEmailDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
        </button>
        <button onclick="createBulkOrderProjectFromDraft('${equipmentId}')" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-clipboard-list mr-2"></i>æ¡ˆä»¶ã‚’ä½œæˆ
        </button>
        <button onclick="closeBulkModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-times mr-2"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  window.currentBulkModal = modal;
  window.currentBulkEquipmentId = equipmentId; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æ¡ˆä»¶ä½œæˆã§ãã‚‹ã‚ˆã†ã«ä¿å­˜
  
  modal.onclick = function(e) {
    if (e.target === modal) closeBulkModal();
  };
}

// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚³ãƒ”ãƒ¼
function copyBulkEmailDraft() {
  const textarea = document.getElementById('email-draft-text');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('âœ… ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch (err) {
    alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeBulkModal() {
  if (window.currentBulkModal) {
    document.body.removeChild(window.currentBulkModal);
    window.currentBulkModal = null;
    window.currentBulkEquipmentId = null;
  }
}

// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‹ã‚‰ç›´æ¥æ¡ˆä»¶ã‚’ä½œæˆ
function createBulkOrderProjectFromDraft(equipmentId) {
  if (!equipmentId && window.currentBulkEquipmentId) {
    equipmentId = window.currentBulkEquipmentId;
  }
  closeBulkModal();
  createBulkOrderProjectFor(equipmentId);
}

// æ¡ˆä»¶ã‚’ä½œæˆ
function createBulkOrderProjectFor(equipmentId) {
  if (!window.bulkOrderDataMap || !window.bulkOrderDataMap[equipmentId]) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  
  const info = window.bulkOrderDataMap[equipmentId];
  const targetCount = info.targetCount;
  const targetYear = info.targetYear || new Date().getFullYear();
  
  if (!confirm(`${targetYear}å¹´åº¦ã®${info.config.name}ä¸€æ‹¬ç™ºæ³¨æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡åº—èˆ—: ${targetCount}åº—èˆ—\nå®Ÿæ–½äºˆå®š: ${targetYear}å¹´4æœˆ\nç™ºæ³¨å…ˆ: ${info.config.vendor}`)) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}\nè¨­å‚™: ${result.equipmentName}\nå¯¾è±¡åº—èˆ—: ${result.targetCount}åº—èˆ—`);
      navigate('projects');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createBulkOrderProject(equipmentId);
}
</script>