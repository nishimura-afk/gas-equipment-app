<!-- Dashboard View -->
<div class="space-y-8">
  <div class="flex justify-between items-center border-b pb-4">
    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-pie mr-2"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <button onclick="dashboardInit(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition shadow">
      <i class="fas fa-sync-alt mr-1"></i> æ›´æ–°
    </button>
  </div>

  <!-- 4æœˆå®Ÿæ–½ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ5ç¨®é¡ï¼‰ -->
  
  <!-- ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ -->
  <div id="bulk-alert-PARTS-PUMP-1Y" data-equipment-id="PARTS-PUMP-1Y" style="display: none;" class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg border-2 border-amber-300 shadow-md overflow-hidden">
    <div class="bg-amber-100 p-3 border-b border-amber-300 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-2xl mr-3">ğŸ“¦</span>
        <h3 class="text-lg font-bold text-amber-900">ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ ä¸€æ‹¬ç™ºæ³¨</h3>
      </div>
      <span class="text-xs bg-white px-3 py-1 rounded text-amber-700 font-bold border border-amber-300 bulk-target-count">0åº—èˆ—</span>
    </div>
    <div class="p-4">
      <div class="flex gap-6 mb-4 text-amber-900">
        <div><span class="font-semibold">å¯¾è±¡åº—èˆ—:</span> <span class="bulk-target-count-text font-bold text-lg">0</span>åº—èˆ—</div>
        <div><span class="font-semibold">å®Ÿæ–½äºˆå®š:</span> <span class="bulk-target-year font-bold text-lg">2026</span>å¹´4æœˆ</div>
        <div><span class="font-semibold">ç™ºæ³¨å…ˆ:</span> <span class="font-bold text-lg">ã‚¿ãƒ„ãƒ</span></div>
      </div>
      <div class="flex gap-3">
        <button onclick="showBulkOrderDraft('PARTS-PUMP-1Y')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-envelope mr-2"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’è¡¨ç¤º
        </button>
        <button onclick="createBulkOrderProjectFor('PARTS-PUMP-1Y')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-clipboard-list mr-2"></i>æ¡ˆä»¶ã‚’ä½œæˆ
        </button>
      </div>
    </div>
  </div>

  <!-- é‡£éŠ­æ©Ÿã‚·ãƒ¼ãƒ« -->
  <div id="bulk-alert-PARTS-SEAL-3Y" data-equipment-id="PARTS-SEAL-3Y" style="display: none;" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-indigo-300 shadow-md overflow-hidden">
    <div class="bg-indigo-100 p-3 border-b border-indigo-300 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-2xl mr-3">ğŸ”§</span>
        <h3 class="text-lg font-bold text-indigo-900">é‡£éŠ­æ©Ÿã‚·ãƒ¼ãƒ«è²¼ã‚Šæ›¿ãˆ ä¸€æ‹¬ç™ºæ³¨</h3>
      </div>
      <span class="text-xs bg-white px-3 py-1 rounded text-indigo-700 font-bold border border-indigo-300 bulk-target-count">0åº—èˆ—</span>
    </div>
    <div class="p-4">
      <div class="flex gap-6 mb-4 text-indigo-900">
        <div><span class="font-semibold">å¯¾è±¡åº—èˆ—:</span> <span class="bulk-target-count-text font-bold text-lg">0</span>åº—èˆ—</div>
        <div><span class="font-semibold">å®Ÿæ–½äºˆå®š:</span> <span class="bulk-target-year font-bold text-lg">2026</span>å¹´4æœˆ</div>
        <div><span class="font-semibold">ç™ºæ³¨å…ˆ:</span> <span class="font-bold text-lg">ã‚·ãƒ£ãƒ¼ãƒ—</span></div>
      </div>
      <div class="flex gap-3">
        <button onclick="showBulkOrderDraft('PARTS-SEAL-3Y')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-envelope mr-2"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’è¡¨ç¤º
        </button>
        <button onclick="createBulkOrderProjectFor('PARTS-SEAL-3Y')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-clipboard-list mr-2"></i>æ¡ˆä»¶ã‚’ä½œæˆ
        </button>
      </div>
    </div>
  </div>

  <!-- é‡£éŠ­æ©Ÿã‚«ãƒãƒ¼ -->
  <div id="bulk-alert-CHG-01" data-equipment-id="CHG-01" style="display: none;" class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-300 shadow-md overflow-hidden">
    <div class="bg-purple-100 p-3 border-b border-purple-300 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-2xl mr-3">ğŸ’³</span>
        <h3 class="text-lg font-bold text-purple-900">é‡£éŠ­æ©Ÿã‚«ãƒãƒ¼ ä¸€æ‹¬ç™ºæ³¨</h3>
      </div>
      <span class="text-xs bg-white px-3 py-1 rounded text-purple-700 font-bold border border-purple-300 bulk-target-count">0åº—èˆ—</span>
    </div>
    <div class="p-4">
      <div class="flex gap-6 mb-4 text-purple-900">
        <div><span class="font-semibold">å¯¾è±¡åº—èˆ—:</span> <span class="bulk-target-count-text font-bold text-lg">0</span>åº—èˆ—</div>
        <div><span class="font-semibold">å®Ÿæ–½äºˆå®š:</span> <span class="bulk-target-year font-bold text-lg">2026</span>å¹´4æœˆ</div>
        <div><span class="font-semibold">ç™ºæ³¨å…ˆ:</span> <span class="font-bold text-lg">ã‚·ãƒ£ãƒ¼ãƒ—</span></div>
      </div>
      <div class="flex gap-3">
        <button onclick="showBulkOrderDraft('CHG-01')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-envelope mr-2"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’è¡¨ç¤º
        </button>
        <button onclick="createBulkOrderProjectFor('CHG-01')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-clipboard-list mr-2"></i>æ¡ˆä»¶ã‚’ä½œæˆ
        </button>
      </div>
    </div>
  </div>

  <!-- è¨ˆé‡æ©Ÿéƒ¨å“4å¹´ -->
  <div id="bulk-alert-PARTS-PUMP-4Y" data-equipment-id="PARTS-PUMP-4Y" style="display: none;" class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-300 shadow-md overflow-hidden">
    <div class="bg-green-100 p-3 border-b border-green-300 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-2xl mr-3">â›½</span>
        <h3 class="text-lg font-bold text-green-900">è¨ˆé‡æ©Ÿéƒ¨å“(4å¹´) ä¸€æ‹¬ç™ºæ³¨</h3>
      </div>
      <span class="text-xs bg-white px-3 py-1 rounded text-green-700 font-bold border border-green-300 bulk-target-count">0åº—èˆ—</span>
    </div>
    <div class="p-4">
      <div class="flex gap-6 mb-4 text-green-900">
        <div><span class="font-semibold">å¯¾è±¡åº—èˆ—:</span> <span class="bulk-target-count-text font-bold text-lg">0</span>åº—èˆ—</div>
        <div><span class="font-semibold">å®Ÿæ–½äºˆå®š:</span> <span class="bulk-target-year font-bold text-lg">2026</span>å¹´4æœˆ</div>
        <div><span class="font-semibold">ç™ºæ³¨å…ˆ:</span> <span class="font-bold text-lg">ã‚¿ãƒ„ãƒ</span></div>
      </div>
      <div class="flex gap-3">
        <button onclick="showBulkOrderDraft('PARTS-PUMP-4Y')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-envelope mr-2"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’è¡¨ç¤º
        </button>
        <button onclick="createBulkOrderProjectFor('PARTS-PUMP-4Y')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-clipboard-list mr-2"></i>æ¡ˆä»¶ã‚’ä½œæˆ
        </button>
      </div>
    </div>
  </div>

  <!-- ç¯æ²¹ãƒ‘ãƒãƒ« -->
  <div id="bulk-alert-PARTS-K-PANEL-7Y" data-equipment-id="PARTS-K-PANEL-7Y" style="display: none;" class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg border-2 border-orange-300 shadow-md overflow-hidden">
    <div class="bg-orange-100 p-3 border-b border-orange-300 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-2xl mr-3">ğŸ›¢ï¸</span>
        <h3 class="text-lg font-bold text-orange-900">ç¯æ²¹ãƒ‘ãƒãƒ«æ›´æ–° ä¸€æ‹¬ç™ºæ³¨</h3>
      </div>
      <span class="text-xs bg-white px-3 py-1 rounded text-orange-700 font-bold border border-orange-300 bulk-target-count">0åº—èˆ—</span>
    </div>
    <div class="p-4">
      <div class="flex gap-6 mb-4 text-orange-900">
        <div><span class="font-semibold">å¯¾è±¡åº—èˆ—:</span> <span class="bulk-target-count-text font-bold text-lg">0</span>åº—èˆ—</div>
        <div><span class="font-semibold">å®Ÿæ–½äºˆå®š:</span> <span class="bulk-target-year font-bold text-lg">2026</span>å¹´4æœˆ</div>
        <div><span class="font-semibold">ç™ºæ³¨å…ˆ:</span> <span class="font-bold text-lg">ã‚¿ãƒ„ãƒ</span></div>
      </div>
      <div class="flex gap-3">
        <button onclick="showBulkOrderDraft('PARTS-K-PANEL-7Y')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-envelope mr-2"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’è¡¨ç¤º
        </button>
        <button onclick="createBulkOrderProjectFor('PARTS-K-PANEL-7Y')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition shadow flex items-center">
          <i class="fas fa-clipboard-list mr-2"></i>æ¡ˆä»¶ã‚’ä½œæˆ
        </button>
      </div>
    </div>
  </div>

  <!-- ä¸Šæ®µ: æ³•å®šæ¤œæŸ» -->
  <div class="bg-white rounded-lg border-2 border-indigo-200 shadow-md overflow-hidden">
    <div class="bg-indigo-50 p-3 border-b border-indigo-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-indigo-800"><i class="fas fa-balance-scale mr-2"></i>ã€æœ€å„ªå…ˆã€‘æ³•å®šæ¤œæŸ»</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-indigo-600 font-bold border border-indigo-200" id="count-legal">0ä»¶</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-indigo-100 text-indigo-800">
          <tr><th class="p-2">æ‹ ç‚¹</th><th class="p-2">è¨­å‚™å</th><th class="p-2">æœŸé™</th></tr>
        </thead>
        <tbody id="table-legal" class="divide-y divide-indigo-100"><tr><td colspan="3" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ä¸­æ®µ: é‡è¦è¨­å‚™ -->
  <div class="bg-white rounded-lg border-2 border-rose-200 shadow-md overflow-hidden">
    <div class="bg-rose-50 p-3 border-b border-rose-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-rose-800"><i class="fas fa-exclamation-triangle mr-2"></i>ã€é‡è¦ã€‘æœ¬ä½“æ›´æ–°ãƒ»å…¥æ›¿</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-rose-600 font-bold border border-rose-200" id="count-major">0ä»¶</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-rose-100 text-rose-800">
          <tr><th class="p-2">æ‹ ç‚¹</th><th class="p-2">è¨­å‚™å</th><th class="p-2">çŠ¶æ³</th></tr>
        </thead>
        <tbody id="table-major" class="divide-y divide-rose-100"><tr><td colspan="3" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ä¸‹æ®µ: å®šä¾‹æ¶ˆè€—å“ -->
  <div class="bg-white rounded-lg border-2 border-amber-200 shadow-md overflow-hidden">
    <div class="bg-amber-50 p-3 border-b border-amber-200 flex justify-between items-center">
      <h3 class="text-lg font-bold text-amber-800"><i class="fas fa-tools mr-2"></i>ã€å®šä¾‹ã€‘å®šæœŸéƒ¨å“äº¤æ›ãƒ»æ¶ˆè€—å“</h3>
      <span class="text-xs bg-white px-2 py-1 rounded text-amber-600 font-bold border border-amber-200" id="count-minor">0ä»¶</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-amber-100 text-amber-800">
          <tr><th class="p-2">æ‹ ç‚¹</th><th class="p-2">å†…å®¹</th><th class="p-2">æ™‚æœŸ</th></tr>
        </thead>
        <tbody id="table-minor" class="divide-y divide-amber-100"><tr><td colspan="3" class="p-4 text-center text-gray-400">ãªã—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- 4æœˆå®Ÿæ–½ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  <div class="bg-white rounded-lg border-2 border-blue-200 shadow-md overflow-hidden">
    <div class="bg-blue-50 p-3 border-b border-blue-200">
      <h3 class="text-lg font-bold text-blue-800"><i class="fas fa-calendar-alt mr-2"></i>ã€4æœˆå®Ÿæ–½ã€‘å®šæœŸéƒ¨å“äº¤æ›ãƒ»ä¸€æ‹¬ç™ºæ³¨</h3>
    </div>
    <div id="bulk-order-alerts" class="divide-y divide-blue-100">
      <div class="p-4 text-center text-gray-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
</div>

<script>
console.log('âœ… dashboard.html script loaded - v2');
function dashboardInit(f=false) {
  if(!f && window.g_cache.dashboard) { 
    renderDashboard(window.g_cache.dashboard); 
    loadAllBulkOrderAlerts();
    return; 
  }
  showLoading(true);
  google.script.run.withSuccessHandler(d => { 
    window.g_cache.dashboard=d; 
    renderDashboard(d); 
    loadAllBulkOrderAlerts();
  }).getDashboardData();
}

function renderDashboard(data) {
  showLoading(false);
  const legalT = document.getElementById('table-legal'); legalT.innerHTML = '';
  const majorT = document.getElementById('table-major'); majorT.innerHTML = '';
  const minorT = document.getElementById('table-minor'); minorT.innerHTML = '';
  
  let lCount = 0, mjCount = 0, mnCount = 0;

  data.noticeList.forEach(i => {
    const category = i['ã‚«ãƒ†ã‚´ãƒª'];
    const tr = document.createElement('tr');
    
    if (category === 'æ³•å®šæ¤œæŸ»') {
      lCount++;
      tr.className = "hover:bg-indigo-50";
      let statusLabel = i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
      let statusColor = (statusLabel === 'æœŸé™è¶…é') ? 'text-red-600' : 'text-indigo-600';
      let status = `<span class="font-bold ${statusColor}">${statusLabel}</span>`;
      tr.innerHTML = `<td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td><td class="p-2">${i['è¨­å‚™å']}</td><td class="p-2">${status}</td>`;
      legalT.appendChild(tr);
    }
    else if (category === 'æœ¬ä½“æ›´æ–°' || category === 'ç¾è¦³') {
      mjCount++;
      tr.className = "hover:bg-rose-50";
      let status = `<span class="font-bold ${i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='æœŸé™è¶…é'?'text-rose-600':'text-amber-600'}">${i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}</span>`;
      if(i['subsidyAlert']) status += `<br><span class="text-xs text-white bg-red-500 px-1 rounded">${i['subsidyAlert']}</span>`;
      tr.innerHTML = `<td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td><td class="p-2">${i['è¨­å‚™å']}</td><td class="p-2">${status}</td>`;
      majorT.appendChild(tr);
    } 
    else {
      mnCount++;
      tr.className = "hover:bg-amber-50";
      let content = [];
      if(i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']!=='æ­£å¸¸') content.push(`æ¶ˆè€—å“: ${i['éƒ¨å“Aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}`);
      if(i['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']!=='æ­£å¸¸' && i['éƒ¨å“Bå¯¾è±¡']) content.push(`æ•´å‚™: ${i['éƒ¨å“Bã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}`);
      if(i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']!=='æ­£å¸¸') content.push(`æœ¬ä½“: ${i['æœ¬ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']}`);
      tr.innerHTML = `<td class="p-2 font-bold">${i['æ‹ ç‚¹å']}</td><td class="p-2">${i['è¨­å‚™å']}</td><td class="p-2 text-xs font-bold text-slate-600">${content.join('<br>')}</td>`;
      minorT.appendChild(tr);
    }
  });

  document.getElementById('count-legal').innerText = lCount + 'ä»¶';
  document.getElementById('count-major').innerText = mjCount + 'ä»¶';
  document.getElementById('count-minor').innerText = mnCount + 'ä»¶';

  if(lCount===0) legalT.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªæ³•å®šæ¤œæŸ»ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
  if(mjCount===0) majorT.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªé‡è¦æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
  if(mnCount===0) minorT.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400 text-xs">å¯¾å¿œãŒå¿…è¦ãªæ¶ˆè€—å“äº¤æ›ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
}

// å…¨ã¦ã®ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒã‚ºãƒ«ã‚«ãƒãƒ¼ + ãã®ä»–4ç¨®é¡ï¼‰
function loadAllBulkOrderAlerts() {
  const container = document.getElementById('bulk-order-alerts');
  if (!container) return;
  
  container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</div>';
  
  // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
  google.script.run
    .withSuccessHandler(function(nozzleInfo) {
      // ãã®ä»–ã®ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(allInfo) {
          window.bulkOrderDataMap = {};
          window.nozzleCoverData = nozzleInfo;
          
          container.innerHTML = '';
          
          let hasAnyAlert = false;
          
          // ãƒã‚ºãƒ«ã‚«ãƒãƒ¼ã‚’è¡¨ç¤º
          if (nozzleInfo && nozzleInfo.hasAlert && nozzleInfo.targetCount > 0) {
            hasAnyAlert = true;
            const div = createBulkAlertDiv(nozzleInfo, 'nozzle');
            container.appendChild(div);
          }
          
          // ãã®ä»–ã®4ç¨®é¡ã‚’è¡¨ç¤º
          allInfo.forEach(function(info) {
            const equipmentId = info.config.id;
            window.bulkOrderDataMap[equipmentId] = info;
            
            if (info.hasAlert) {
              hasAnyAlert = true;
              const div = createBulkAlertDiv(info, 'standard');
              container.appendChild(div);
            }
          });
          
          if (!hasAnyAlert) {
            container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">4æœˆå®Ÿæ–½äºˆå®šã®ä¸€æ‹¬ç™ºæ³¨ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          }
        })
        .withFailureHandler(function(error) {
          console.error('ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
          container.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">ä¸€æ‹¬ç™ºæ³¨æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        })
        .getAllBulkOrderInfo();
    })
    .withFailureHandler(function(error) {
      console.error('ãƒã‚ºãƒ«ã‚«ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
      container.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    })
    .getNozzleCoverInfo();
}

// ä¸€æ‹¬ç™ºæ³¨ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã‚’ä½œæˆ
function createBulkAlertDiv(info, type) {
  const div = document.createElement('div');
  div.className = 'p-4 border-b border-blue-100 hover:bg-blue-50 transition';
  
  let storeList = '';
  if (info.targetStores && info.targetStores.length > 0) {
    if (info.targetStores.length <= 8) {
      storeList = info.targetStores.map(function(s) { return s.name; }).join(', ');
    } else {
      storeList = info.targetStores.slice(0, 5).map(function(s) { return s.name; }).join(', ') + ' ä»–' + (info.targetStores.length - 5) + 'åº—èˆ—';
    }
  }
  
  const equipmentId = info.config.id;
  const isNozzle = (type === 'nozzle');
  
  const buttons = isNozzle ? `
    <button onclick="showNozzleCoverEmailDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope mr-1"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã
    </button>
    <button onclick="createNozzleCoverGmailDraft()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope-open mr-1"></i>Gmailä¸‹æ›¸ãä½œæˆ
    </button>
    <button onclick="createNozzleCoverProject()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-clipboard-list mr-1"></i>æ¡ˆä»¶ä½œæˆ
    </button>
  ` : `
    <button onclick="showBulkEmailDraft('${equipmentId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope mr-1"></i>ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã
    </button>
    <button onclick="createBulkOrderGmailDraftFor('${equipmentId}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-envelope-open mr-1"></i>Gmailä¸‹æ›¸ãä½œæˆ
    </button>
    <button onclick="createBulkOrderProjectFor('${equipmentId}')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs transition shadow">
      <i class="fas fa-clipboard-list mr-1"></i>æ¡ˆä»¶ä½œæˆ
    </button>
  `;
  
  div.innerHTML = `
    <div class="flex items-start justify-between mb-2">
      <div class="flex-1">
        <div class="text-base font-bold text-blue-900 mb-1">
          <span class="text-xl mr-2">${info.config.emoji}</span>
          ${info.config.name} (${info.targetYear}å¹´4æœˆå®Ÿæ–½äºˆå®š) - ${info.targetCount}åº—èˆ—
        </div>
        <div class="text-sm text-blue-700 ml-7 mt-1">
          å¯¾è±¡: ${storeList}
        </div>
      </div>
    </div>
    <div class="flex gap-2 ml-7 mt-2">
      ${buttons}
    </div>
  `;
  
  return div;
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãè¡¨ç¤º
function showNozzleCoverEmailDraft() {
  if (!window.nozzleCoverData) {
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™');
    return;
  }
  
  const info = window.nozzleCoverData;
  const modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
  
  const content = document.createElement('div');
  content.className = 'bg-white rounded-lg shadow-2xl';
  content.style.cssText = 'max-width: 700px; max-height: 85vh; width: 90%;';
  
  content.innerHTML = `
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-lg">
      <h2 class="text-xl font-bold"><i class="fas fa-envelope mr-2"></i>ğŸ“¦ ${info.config.name} - ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã</h2>
    </div>
    <div class="p-6">
      <textarea id="nozzle-email-draft-text" readonly class="w-full h-96 font-mono text-sm p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" style="resize: none;">${info.emailDraft}</textarea>
      <div class="mt-4 flex gap-3 justify-end">
        <button onclick="copyNozzleEmailDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
        </button>
        <button onclick="closeNozzleModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-times mr-2"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  window.currentNozzleModal = modal;
  
  modal.onclick = function(e) {
    if (e.target === modal) closeNozzleModal();
  };
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚³ãƒ”ãƒ¼
function copyNozzleEmailDraft() {
  const textarea = document.getElementById('nozzle-email-draft-text');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('âœ… ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch (err) {
    alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  }
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeNozzleModal() {
  if (window.currentNozzleModal) {
    document.body.removeChild(window.currentNozzleModal);
    window.currentNozzleModal = null;
  }
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›Gmailä¸‹æ›¸ãä½œæˆ
function createNozzleCoverGmailDraft() {
  if (!confirm('Gmailã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert('âœ… ' + result.message + '\n\nä»¶å: ' + result.subject + '\nå®›å…ˆ: ' + result.recipient + '\n\nGmailã®ä¸‹æ›¸ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ Gmailä¸‹æ›¸ãä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createNozzleCoverGmailDraft();
}

// ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›æ¡ˆä»¶ä½œæˆ
function createNozzleCoverProject() {
  if (!window.nozzleCoverData) {
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™');
    return;
  }
  
  const info = window.nozzleCoverData;
  
  if (!confirm(`ãƒã‚ºãƒ«ã‚«ãƒãƒ¼äº¤æ›ã®ä¸€æ‹¬æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹?\n\nå¯¾è±¡: ${info.targetCount}åº—èˆ—ï¼ˆå…¨åº—ï¼‰\nå®Ÿæ–½äºˆå®š: ${info.targetYear}å¹´4æœˆ`)) {
    return;
  }
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}\nè¨­å‚™: ${result.equipmentName}\nå¯¾è±¡åº—èˆ—: ${result.targetCount}åº—èˆ—`);
      navigate('projects');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createNozzleCoverProject();
}

// Gmailä¸‹æ›¸ãä½œæˆ
function createBulkOrderGmailDraftFor(equipmentId) {
  if (!confirm('Gmailã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert('âœ… ' + result.message + '\n\nä»¶å: ' + result.subject + '\nå®›å…ˆ: ' + result.recipient + '\n\nGmailã®ä¸‹æ›¸ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ Gmailä¸‹æ›¸ãä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createBulkOrderGmailDraft(equipmentId);
}

// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’è¡¨ç¤º
function showBulkEmailDraft(equipmentId) {
  const info = window.bulkOrderData ? window.bulkOrderData.find(d => d.config.id === equipmentId) : (window.bulkOrderDataMap ? window.bulkOrderDataMap[equipmentId] : null);
  if (!info) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  showBulkOrderDraft(equipmentId);
}

function showBulkOrderDraft(equipmentId) {
  if (!window.bulkOrderDataMap || !window.bulkOrderDataMap[equipmentId]) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  
  const info = window.bulkOrderDataMap[equipmentId];
  const draft = info.emailDraft;
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
  
  const content = document.createElement('div');
  content.className = 'bg-white rounded-lg shadow-2xl';
  content.style.cssText = 'max-width: 700px; max-height: 85vh; width: 90%;';
  
  content.innerHTML = `
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-lg">
      <h2 class="text-xl font-bold"><i class="fas fa-envelope mr-2"></i>${info.config.emoji} ${info.config.name} - ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ã</h2>
    </div>
    <div class="p-6">
      <textarea id="email-draft-text" readonly class="w-full h-96 font-mono text-sm p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" style="resize: none;">${draft}</textarea>
      <div class="mt-4 flex gap-3 justify-end">
        <button onclick="copyBulkEmailDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
        </button>
        <button onclick="createBulkOrderProjectFromDraft('${equipmentId}')" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-clipboard-list mr-2"></i>æ¡ˆä»¶ã‚’ä½œæˆ
        </button>
        <button onclick="closeBulkModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded transition shadow">
          <i class="fas fa-times mr-2"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  window.currentBulkModal = modal;
  window.currentBulkEquipmentId = equipmentId; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æ¡ˆä»¶ä½œæˆã§ãã‚‹ã‚ˆã†ã«ä¿å­˜
  
  modal.onclick = function(e) {
    if (e.target === modal) closeBulkModal();
  };
}

// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚³ãƒ”ãƒ¼
function copyBulkEmailDraft() {
  const textarea = document.getElementById('email-draft-text');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('âœ… ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch (err) {
    alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeBulkModal() {
  if (window.currentBulkModal) {
    document.body.removeChild(window.currentBulkModal);
    window.currentBulkModal = null;
    window.currentBulkEquipmentId = null;
  }
}

// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãã‹ã‚‰ç›´æ¥æ¡ˆä»¶ã‚’ä½œæˆ
function createBulkOrderProjectFromDraft(equipmentId) {
  if (!equipmentId && window.currentBulkEquipmentId) {
    equipmentId = window.currentBulkEquipmentId;
  }
  closeBulkModal();
  createBulkOrderProjectFor(equipmentId);
}

// æ¡ˆä»¶ã‚’ä½œæˆ
function createBulkOrderProjectFor(equipmentId) {
  if (!window.bulkOrderDataMap || !window.bulkOrderDataMap[equipmentId]) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
    return;
  }
  
  const info = window.bulkOrderDataMap[equipmentId];
  const targetCount = info.targetCount;
  const targetYear = info.targetYear || new Date().getFullYear();
  
  if (!confirm(`${targetYear}å¹´åº¦ã®${info.config.name}ä¸€æ‹¬ç™ºæ³¨æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡åº—èˆ—: ${targetCount}åº—èˆ—\nå®Ÿæ–½äºˆå®š: ${targetYear}å¹´4æœˆ\nç™ºæ³¨å…ˆ: ${info.config.vendor}`)) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      alert(`âœ… æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã—ãŸ\n\næ¡ˆä»¶ID: ${result.projectId}\nè¨­å‚™: ${result.equipmentName}\nå¯¾è±¡åº—èˆ—: ${result.targetCount}åº—èˆ—`);
      navigate('projects');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      alert('âŒ æ¡ˆä»¶ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error);
    })
    .createBulkOrderProject(equipmentId);
}
</script>